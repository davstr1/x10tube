extends layout

block content
  //- Header section
  section.mb-6
    //- Title (editable if owner)
    if isOwner
      form#title-form(action=`/s/${x10.id}/title` method="POST")
        input#title-input.text-2xl.font-semibold.text-text-primary.bg-transparent.border-b-2.border-transparent.hover_border-border-strong.focus_border-red-500.focus_outline-none.w-full.py-1.transition-colors(
          type="text"
          name="title"
          value=x10.title || 'Untitled'
          placeholder="Give your x10 a title..."
        )
    else
      h1.text-2xl.font-semibold.text-text-primary= x10.title || 'Untitled'

    p.text-sm.text-text-secondary.mt-2
      | #{x10.videos.length} item#{x10.videos.length > 1 ? 's' : ''}
      span.mx-2 Â·
      | #{tokenDisplay}
      span.mx-2 Â·
      | #{createdDate}

  //- Action buttons
  section.mb-10
    - const mdUrl = `${process.env.BASE_URL || 'http://localhost:3000'}/s/${x10.id}.md`
    - const fullPrompt = 'Fetch ' + mdUrl + '\n\n' + (effectivePrePrompt || '')
    - const claudePrompt = encodeURIComponent(fullPrompt)
    - const chatgptPrompt = encodeURIComponent(fullPrompt)

    style.
      .dropdown { position: relative; }
      .dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 50;
        min-width: 12rem;
        padding-top: 0.25rem;
      }
      .dropdown-menu-inner {
        background: var(--color-surface);
        border: 1px solid var(--color-border-strong);
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        padding: 0.25rem 0;
      }
      .dropdown-menu-inner button,
      .dropdown-menu-inner a {
        text-align: left !important;
      }
      .dropdown:hover .dropdown-menu { display: block; }

    .flex.flex-wrap.gap-3.items-center
      //- Open in... dropdown (hover to open)
      .inline-block.dropdown
        button.inline-flex.items-center.gap-2.bg-red-600.hover_bg-red-700.text-white.px-5.py-3.rounded-lg.text-sm.font-medium.transition-colors(
          type="button"
        )
          | Open in...
          span.ml-1 â–¾
        .dropdown-menu
          .dropdown-menu-inner
            a.block.px-4.py-2.text-sm.text-text-primary.hover_bg-surface-hover.no-underline(
              href=`https://claude.ai/new?q=${claudePrompt}`
              target="_blank"
            ) Claude
            a.block.px-4.py-2.text-sm.text-text-primary.hover_bg-surface-hover.no-underline(
              href=`https://chat.openai.com/?q=${chatgptPrompt}`
              target="_blank"
            ) ChatGPT
            a.block.px-4.py-2.text-sm.text-text-primary.hover_bg-surface-hover.no-underline(
              href=`https://www.google.com/search?udm=50&aep=11&q=${claudePrompt}`
              target="_blank"
            ) Gemini
            a.block.px-4.py-2.text-sm.text-text-primary.hover_bg-surface-hover.no-underline(
              href=`https://www.perplexity.ai/search/?q=${claudePrompt}`
              target="_blank"
            ) Perplexity
            a.block.px-4.py-2.text-sm.text-text-primary.hover_bg-surface-hover.no-underline(
              href=`https://x.com/i/grok?text=${claudePrompt}`
              target="_blank"
            ) Grok
            a.block.px-4.py-2.text-sm.text-text-primary.hover_bg-surface-hover.no-underline(
              href=`https://copilot.microsoft.com/`
              target="_blank"
            ) Copilot

      //- Copy dropdown
      - const x10Url = `${process.env.BASE_URL || 'http://localhost:3000'}/s/${x10.id}`
      .inline-block.dropdown
        button.inline-flex.items-center.gap-2.bg-surface.hover_bg-surface-hover.text-text-primary.px-5.py-3.rounded-lg.text-sm.font-medium.border.border-border-strong.transition-colors(
          type="button"
        )
          | Copy...
          span.ml-1 â–¾
        .dropdown-menu
          .dropdown-menu-inner
            button.block.w-full.text-left.px-4.py-2.text-sm.text-text-primary.hover_bg-surface-hover(
              type="button"
              onclick=`navigator.clipboard.writeText('${mdUrl}'); this.textContent='Copied!'; setTimeout(() => this.textContent='MD Link', 1500)`
            ) MD Link
            button#copy-md-btn.block.w-full.text-left.px-4.py-2.text-sm.text-text-primary.hover_bg-surface-hover(
              type="button"
            ) MD Content
            button.block.w-full.text-left.px-4.py-2.text-sm.text-text-primary.hover_bg-surface-hover(
              type="button"
              onclick=`navigator.clipboard.writeText('${x10Url}'); this.textContent='Copied!'; setTimeout(() => this.textContent='This X10 URL', 1500)`
            ) This X10 URL

      //- Spacer to push delete to the right
      .flex-1
      if isOwner
        form.inline(action=`/x10/${x10.id}/delete` method="POST")
          button.w-8.h-8.flex.items-center.justify-center.text-text-muted.hover_text-red-500.hover_bg-red-500.hover_bg-opacity-10.rounded-full.transition-colors(
            type="submit"
            title="Delete this x10"
            onclick="return confirm('Delete this x10?')"
          ) Ã—

  //- Items list (videos + web pages)
  section.mb-10
    .space-y-4
      each item, index in x10.videos
        - const isYouTube = item.type === 'youtube' || item.youtube_id
        - const thumbnailUrl = isYouTube ? `https://img.youtube.com/vi/${item.youtube_id}/mqdefault.jpg` : `https://www.google.com/s2/favicons?domain=${item.channel}&sz=128`
        - const itemId = isYouTube ? item.youtube_id : item.id
        .border.border-border-strong.rounded-lg.bg-surface
          .flex.gap-4.p-4
            //- Thumbnail
            a.flex-shrink-0.block(href=item.url target="_blank" title=isYouTube ? "Watch on YouTube" : "Open page")
              if isYouTube
                img.w-44.h-24.object-cover.rounded-md(src=thumbnailUrl alt=item.title)
              else
                .w-44.h-24.rounded-md.bg-surface-alt.flex.items-center.justify-center
                  img.w-12.h-12(src=thumbnailUrl alt=item.channel)

            //- Item info
            - const itemMdUrl = `${process.env.BASE_URL || 'http://localhost:3000'}/s/${x10.id}/v/${itemId}.md`
            - const itemPrompt = 'Fetch ' + itemMdUrl + '\n\n' + (effectivePrePrompt || '')
            - const itemPromptEncoded = encodeURIComponent(itemPrompt)
            .flex-1.min-w-0
              .flex.justify-between.items-start.gap-2
                div.min-w-0
                  h3.font-medium.text-text-primary.leading-snug.mb-1
                    span.text-text-muted.mr-1 #{index + 1}.
                    if !isYouTube
                      span.text-xs.text-text-muted.mr-1 ðŸŒ
                    = item.title
                  p.text-sm.text-text-secondary
                    = item.channel
                    if item.duration
                      span.mx-1 Â·
                      = item.duration

                  //- Item actions
                  .flex.items-center.gap-3.mt-2
                    //- Open in... dropdown
                    .dropdown.text-xs
                      button.text-text-muted.hover_text-text-secondary(type="button")
                        | Open in...
                        span.ml-1 â–¾
                      .dropdown-menu
                        .dropdown-menu-inner
                          a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://claude.ai/new?q=${itemPromptEncoded}` target="_blank") Claude
                          a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://chat.openai.com/?q=${itemPromptEncoded}` target="_blank") ChatGPT
                          a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://www.google.com/search?udm=50&aep=11&q=${itemPromptEncoded}` target="_blank") Gemini
                          a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://www.perplexity.ai/search/?q=${itemPromptEncoded}` target="_blank") Perplexity
                          a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://x.com/i/grok?text=${itemPromptEncoded}` target="_blank") Grok
                          a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://copilot.microsoft.com/` target="_blank") Copilot

                    //- Copy... dropdown
                    .dropdown.text-xs
                      button.text-text-muted.hover_text-text-secondary(type="button")
                        | Copy...
                        span.ml-1 â–¾
                      .dropdown-menu
                        .dropdown-menu-inner
                          button.block.w-full.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover(
                            type="button"
                            onclick=`navigator.clipboard.writeText('${itemMdUrl}'); this.textContent='Copied!'; setTimeout(() => this.textContent='MD Link', 1500)`
                          ) MD Link
                          button.block.w-full.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.copy-item-md-btn(
                            type="button"
                            data-item-id=itemId
                          ) MD Content

                if isOwner
                  form(action=`/s/${x10.id}/remove/${item.id}` method="POST")
                    button.w-8.h-8.flex.items-center.justify-center.text-text-muted.hover_text-red-500.hover_bg-red-500.hover_bg-opacity-10.rounded-full.transition-colors(
                      type="submit"
                      title="Remove item"
                    ) Ã—

          //- Content accordion
          details.border-t.border-border-default.group
            summary.px-4.py-3.text-sm.text-text-secondary.cursor-pointer.hover_bg-surface-hover.select-none.flex.items-center.gap-2
              span.text-text-muted.transition-transform.group-open_rotate-90 â–¶
              | #{isYouTube ? 'Show transcript' : 'Show content'}
            .px-4.py-4.bg-surface-alt.text-sm.text-text-secondary.leading-relaxed.max-h-72.overflow-y-auto
              p.whitespace-pre-wrap= item.transcript

  //- Add item form (for owner)
  if isOwner
    section.mb-10
      h3.text-lg.font-semibold.text-text-primary.mb-4 Add content

      if x10.videos.length >= 10
        p.text-sm.text-text-secondary Maximum 10 items reached
      else
        form.flex.gap-3(action=`/s/${x10.id}/add` method="POST")
          input.flex-1.px-4.py-3.border.border-border-strong.rounded-lg.text-sm.focus_outline-none.focus_ring-2.focus_ring-red-500.focus_border-transparent.font-mono.bg-surface.text-text-primary.placeholder-text-muted(
            type="text"
            name="url"
            placeholder="https://youtube.com/watch?v=..."
            required
          )
          button.bg-red-600.hover_bg-red-700.text-white.px-6.py-3.rounded-lg.text-sm.font-medium.transition-colors.flex-shrink-0(type="submit")
            | Add

  //- Copy to account button (for non-owners who are logged in)
  if currentUser && !isOwner
    section.mb-10
      form(action=`/api/x10/${x10.id}/fork` method="POST")
        button.bg-surface.hover_bg-surface-hover.text-text-primary.px-5.py-3.rounded-lg.text-sm.font-medium.border.border-border-strong.transition-colors(type="submit")
          | Copy to my account

  //- Settings section (bottom)
  if isOwner
    section.border-t.border-border-strong.pt-8
      h2.text-lg.font-semibold.text-text-primary.mb-6 Settings

      //- Prompt for this x10
      .bg-surface.border.border-border-strong.rounded-lg.p-4
        .flex.justify-between.items-center.mb-2
          p.text-sm.text-text-secondary Prompt for this x10
          button#save-preprompt.text-xs.text-red-600.hover_text-red-700.hidden(type="button") Save
        textarea#x10-preprompt.w-full.px-3.py-2.border.border-border-strong.rounded-md.text-sm.focus_outline-none.focus_border-text-muted.resize-none.bg-surface.text-text-primary(
          rows="2"
          placeholder=defaultPrePrompt
        )= x10.pre_prompt || effectivePrePrompt
        p.text-xs.text-text-muted.mt-2 Instructions sent to the LLM after fetching the content

  script.
    (function() {
      // Title auto-save functionality
      const titleForm = document.getElementById('title-form');
      const titleInput = document.getElementById('title-input');
      if (titleForm && titleInput) {
        const originalTitle = titleInput.value;

        // Submit on blur if changed
        titleInput.addEventListener('blur', function() {
          if (titleInput.value !== originalTitle && titleInput.value.trim() !== '') {
            titleForm.submit();
          }
        });

        // Submit on Enter key
        titleInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            if (titleInput.value !== originalTitle && titleInput.value.trim() !== '') {
              titleForm.submit();
            } else {
              titleInput.blur();
            }
          }
        });
      }

      // Pre-prompt save functionality
      const prepromptTextarea = document.getElementById('x10-preprompt');
      const saveBtn = document.getElementById('save-preprompt');

      if (prepromptTextarea && saveBtn) {
        const originalValue = prepromptTextarea.value;

        prepromptTextarea.addEventListener('input', function() {
          saveBtn.classList.toggle('hidden', prepromptTextarea.value === originalValue);
        });

        saveBtn.addEventListener('click', async function() {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/s/#{x10.id}/preprompt';
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'prePrompt';
          input.value = prepromptTextarea.value;
          form.appendChild(input);
          document.body.appendChild(form);
          form.submit();
        });
      }

      // Copy MD functionality (full x10)
      const copyMdBtn = document.getElementById('copy-md-btn');
      if (copyMdBtn) {
        copyMdBtn.addEventListener('click', async function() {
          try {
            const response = await fetch('/s/#{x10.id}.md');
            const md = await response.text();
            await navigator.clipboard.writeText(md);
            copyMdBtn.textContent = 'Copied!';
            setTimeout(() => copyMdBtn.textContent = 'MD Content', 1500);
          } catch (e) {
            copyMdBtn.textContent = 'Error';
            setTimeout(() => copyMdBtn.textContent = 'MD Content', 1500);
          }
        });
      }

      // Copy MD functionality (individual items)
      document.querySelectorAll('.copy-item-md-btn').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          const itemId = btn.dataset.itemId;
          try {
            const response = await fetch('/s/#{x10.id}/v/' + itemId + '.md');
            const md = await response.text();
            await navigator.clipboard.writeText(md);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'MD Content', 1500);
          } catch (e) {
            btn.textContent = 'Error';
            setTimeout(() => btn.textContent = 'MD Content', 1500);
          }
        });
      });
    })();
