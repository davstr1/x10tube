extends layout

block content
  //- Header section
  section.mb-6
    //- Title (editable if owner)
    if isOwner
      form(action=`/s/${x10.id}/title` method="POST")
        input.text-2xl.font-semibold.text-gray-900.bg-transparent.border-b-2.border-transparent.hover_border-gray-200.focus_border-red-500.focus_outline-none.w-full.py-1.transition-colors(
          type="text"
          name="title"
          value=x10.title || 'Untitled'
          placeholder="Give your x10 a title..."
        )
    else
      h1.text-2xl.font-semibold.text-gray-900= x10.title || 'Untitled'

    p.text-sm.text-gray-500.mt-2
      | #{x10.videos.length} video#{x10.videos.length > 1 ? 's' : ''}
      span.mx-2 ·
      | #{tokenDisplay}
      span.mx-2 ·
      | #{createdDate}

  //- Action buttons
  section.mb-10
    - const mdUrl = `${process.env.BASE_URL || 'http://localhost:3000'}/s/${x10.id}.md`
    - const fullPrompt = (effectivePrePrompt || '') + '\n\nIf you cannot read the URL, ask me to paste the content.\n\nRead ' + mdUrl + ' which contains transcripts from multiple YouTube videos.'
    - const claudePrompt = encodeURIComponent(fullPrompt)
    - const chatgptPrompt = encodeURIComponent(fullPrompt)

    .flex.flex-wrap.gap-3.items-center
      a.inline-flex.items-center.gap-2.bg-red-600.hover_bg-red-700.text-white.px-5.py-3.rounded-lg.text-sm.font-medium.no-underline.transition-colors(
        href=`https://claude.ai/new?q=${claudePrompt}`
        target="_blank"
      ) Open in Claude

      a.inline-flex.items-center.gap-2.bg-gray-800.hover_bg-gray-900.text-white.px-5.py-3.rounded-lg.text-sm.font-medium.no-underline.transition-colors(
        href=`https://chat.openai.com/?q=${chatgptPrompt}`
        target="_blank"
      ) Open in ChatGPT

      button.inline-flex.items-center.gap-2.bg-white.hover_bg-gray-50.text-gray-700.px-5.py-3.rounded-lg.text-sm.font-medium.border.border-gray-200.transition-colors(
        type="button"
        onclick=`navigator.clipboard.writeText('${mdUrl}'); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy .md link', 2000)`
      ) Copy .md link

      button#copy-md-btn.inline-flex.items-center.gap-2.bg-white.hover_bg-gray-50.text-gray-700.px-5.py-3.rounded-lg.text-sm.font-medium.border.border-gray-200.transition-colors(
        type="button"
      ) Copy MD

      if isOwner
        form.inline(action=`/x10/${x10.id}/delete` method="POST")
          button.text-sm.text-gray-400.hover_text-red-600.transition-colors(
            type="submit"
            onclick="return confirm('Delete this x10?')"
          ) Delete

  //- Videos list
  section.mb-10
    .space-y-4
      each video, index in x10.videos
        - const thumbnailUrl = `https://img.youtube.com/vi/${video.youtube_id}/mqdefault.jpg`
        .border.border-gray-200.rounded-lg.overflow-hidden.bg-white
          .flex.gap-4.p-4
            //- Thumbnail
            a.flex-shrink-0.block(href=video.url target="_blank" title="Watch on YouTube")
              img.w-44.h-24.object-cover.rounded-md(src=thumbnailUrl alt=video.title)

            //- Video info
            .flex-1.min-w-0
              .flex.justify-between.items-start.gap-2
                div.min-w-0
                  h3.font-medium.text-gray-900.leading-snug.mb-1
                    span.text-gray-400.mr-1 #{index + 1}.
                    = video.title
                  p.text-sm.text-gray-500
                    = video.channel
                    span.mx-1 ·
                    = video.duration

                if isOwner
                  form(action=`/s/${x10.id}/remove/${video.id}` method="POST")
                    button.w-8.h-8.flex.items-center.justify-center.text-gray-300.hover_text-red-500.hover_bg-red-50.rounded-full.transition-colors(
                      type="submit"
                      title="Remove video"
                    ) ×

          //- Transcript accordion
          details.border-t.border-gray-100.group
            summary.px-4.py-3.text-sm.text-gray-500.cursor-pointer.hover_bg-gray-50.select-none.flex.items-center.gap-2
              span.text-gray-400.transition-transform.group-open_rotate-90 ▶
              | Show transcript
            .px-4.py-4.bg-gray-50.text-sm.text-gray-600.leading-relaxed.max-h-72.overflow-y-auto
              p.whitespace-pre-wrap= video.transcript

  //- Add video form (for owner)
  if isOwner
    section.mb-10
      h3.text-lg.font-semibold.text-gray-900.mb-4 Add a video

      if x10.videos.length >= 10
        p.text-sm.text-gray-500 Maximum 10 videos reached
      else
        form.flex.gap-3(action=`/s/${x10.id}/add` method="POST")
          input.flex-1.px-4.py-3.border.border-gray-200.rounded-lg.text-sm.focus_outline-none.focus_ring-2.focus_ring-red-500.focus_border-transparent.font-mono.placeholder-gray-400(
            type="text"
            name="url"
            placeholder="https://youtube.com/watch?v=..."
            required
          )
          button.bg-red-600.hover_bg-red-700.text-white.px-6.py-3.rounded-lg.text-sm.font-medium.transition-colors.flex-shrink-0(type="submit")
            | Add

  //- Copy to account button (for non-owners who are logged in)
  if currentUser && !isOwner
    section.mb-10
      form(action=`/api/x10/${x10.id}/fork` method="POST")
        button.bg-white.hover_bg-gray-50.text-gray-700.px-5.py-3.rounded-lg.text-sm.font-medium.border.border-gray-200.transition-colors(type="submit")
          | Copy to my account

  //- Settings section (bottom)
  if isOwner
    section.border-t.border-gray-200.pt-8
      h2.text-lg.font-semibold.text-gray-900.mb-6 Settings

      //- Pre-prompt for this x10
      .bg-white.border.border-gray-200.rounded-lg.p-4
        .flex.justify-between.items-center.mb-2
          p.text-sm.text-gray-500 Pre-prompt for this x10
          button#save-preprompt.text-xs.text-blue-600.hover_text-blue-800.hidden(type="button") Save
        textarea#x10-preprompt.w-full.px-3.py-2.border.border-gray-200.rounded-md.text-sm.focus_outline-none.focus_border-gray-400.resize-none(
          rows="2"
          placeholder=defaultPrePrompt
        )= x10.pre_prompt || effectivePrePrompt
        p.text-xs.text-gray-400.mt-2 This prompt is sent to the LLM when opening in Claude or ChatGPT

  script.
    (function() {
      // Pre-prompt save functionality
      const prepromptTextarea = document.getElementById('x10-preprompt');
      const saveBtn = document.getElementById('save-preprompt');

      if (prepromptTextarea && saveBtn) {
        const originalValue = prepromptTextarea.value;

        prepromptTextarea.addEventListener('input', function() {
          saveBtn.classList.toggle('hidden', prepromptTextarea.value === originalValue);
        });

        saveBtn.addEventListener('click', async function() {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/s/#{x10.id}/preprompt';
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'prePrompt';
          input.value = prepromptTextarea.value;
          form.appendChild(input);
          document.body.appendChild(form);
          form.submit();
        });
      }

      // Copy MD functionality
      const copyMdBtn = document.getElementById('copy-md-btn');
      if (copyMdBtn) {
        copyMdBtn.addEventListener('click', async function() {
          try {
            const response = await fetch('/s/#{x10.id}.md');
            const md = await response.text();
            await navigator.clipboard.writeText(md);
            copyMdBtn.textContent = 'Copied!';
            setTimeout(() => copyMdBtn.textContent = 'Copy MD', 2000);
          } catch (e) {
            copyMdBtn.textContent = 'Error';
            setTimeout(() => copyMdBtn.textContent = 'Copy MD', 2000);
          }
        });
      }
    })();
