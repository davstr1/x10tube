extends layout
include mixins/extension-required

block content
  +extensionRequired()

  .flex.justify-between.items-center.mb-8
    h1.text-2xl.font-semibold.text-text-primary.flex.items-center.gap-3
      svg.text-text-muted(viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:28px;height:28px;")
        circle(cx="12" cy="12" r="3")
        path(d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z")
      | Settings

  if saved
    .bg-green-900.border.border-green-700.text-green-200.rounded-lg.p-4.mb-6.text-sm
      | Settings saved successfully.

  //- YouTube Power Mode
  .bg-surface.border.border-border-strong.rounded-lg.p-4.mb-6
    .flex.justify-between.items-start.gap-4
      div
        p.text-sm.text-text-primary.font-medium.mb-1 YouTube Power Mode
        p.text-sm.text-text-muted
          | Show icons next to video titles on YouTube.
          br
          | Click them to quickly add videos without opening each one.
      label.flex-shrink-0(style="cursor: pointer;")
        input#youtube-power-mode-checkbox(type="checkbox" checked=(settings.youtube_power_mode !== false) style="display: none;")
        .toggle-switch(style="width: 44px; height: 24px; border-radius: 12px; position: relative; transition: background 0.2s;")
          .toggle-knob(style="width: 20px; height: 20px; border-radius: 10px; background: white; position: absolute; top: 2px; transition: left 0.2s;")

  //- Default prompt
  .bg-surface.border.border-border-strong.rounded-lg.p-4.mb-6
    .flex.justify-between.items-center.mb-2
      p.text-sm.text-text-primary.font-medium Default prompt
      button#save-preprompt.text-xs.text-red-600.hover_text-red-700.hidden(type="button") Save
    textarea#default-preprompt.w-full.px-3.py-2.border.border-border-strong.rounded-md.text-sm.focus_outline-none.focus_border-text-muted.resize-none.bg-surface.text-text-primary(
      rows="2"
      placeholder="Summarize the content. What do we learn?"
    )= settings.default_pre_prompt
    p.text-xs.text-text-muted.mt-2 Instructions sent to the LLM after fetching the content

  //- User code section
  .bg-surface.border.border-border-strong.rounded-lg.p-4
    .flex.justify-between.items-center
      div
        p.text-sm.text-text-primary.font-medium.mb-1 Your user code
        .flex.items-center.gap-2
          code#user-code-display.text-sm.font-mono.text-text-primary.bg-surface-alt.px-2.py-1.rounded ••••••••••••••••
          button#toggle-code.text-text-muted.hover_text-text-secondary(
            type="button"
            title="Show code"
            style="padding: 4px;"
          )
            //- Eye open (show when hidden)
            svg#eye-open(fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z")
            //- Eye closed/slashed (show when visible)
            svg#eye-closed(fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px; display: none;")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21")
          button#copy-code.text-xs.text-red-600.hover_text-red-700(
            type="button"
          ) Copy
      .flex.items-center.gap-4
        a.text-sm.text-text-secondary.hover_text-text-primary(href="/sync") Sync from another device
        button#disconnect-btn.text-sm.text-text-muted.hover_text-red-600(type="button") Disconnect

  script.
    (function() {
      // YouTube Power Mode toggle
      const ytCheckbox = document.getElementById('youtube-power-mode-checkbox');
      const toggleSwitch = document.querySelector('.toggle-switch');
      const toggleKnob = document.querySelector('.toggle-knob');

      function updateToggleUI() {
        if (ytCheckbox.checked) {
          toggleSwitch.style.background = '#dc2626';
          toggleKnob.style.left = '22px';
        } else {
          toggleSwitch.style.background = '#3f3f3f';
          toggleKnob.style.left = '2px';
        }
      }

      // Set initial state
      updateToggleUI();

      // Handle click
      ytCheckbox.addEventListener('change', async function() {
        updateToggleUI();
        // Save to server
        try {
          await fetch('/api/settings/youtube-power-mode', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: ytCheckbox.checked })
          });
        } catch (e) {
          console.error('Failed to save YouTube Power Mode setting:', e);
        }
      });

      // User code functionality
      const userCode = '#{userCode}';
      const display = document.getElementById('user-code-display');
      const toggleBtn = document.getElementById('toggle-code');
      const copyBtn = document.getElementById('copy-code');
      const eyeOpen = document.getElementById('eye-open');
      const eyeClosed = document.getElementById('eye-closed');
      let visible = false;

      toggleBtn.addEventListener('click', function() {
        visible = !visible;
        display.textContent = visible ? userCode : '••••••••••••••••';
        toggleBtn.title = visible ? 'Hide code' : 'Show code';
        eyeOpen.style.display = visible ? 'none' : 'block';
        eyeClosed.style.display = visible ? 'block' : 'none';
      });

      copyBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(userCode);
        copyBtn.textContent = 'Copied!';
        setTimeout(function() { copyBtn.textContent = 'Copy'; }, 1500);
      });

      var disconnectBtn = document.getElementById('disconnect-btn');
      disconnectBtn.addEventListener('click', function() {
        var confirmed = confirm('Warning: Make sure you have saved your user code!\n\nThis is the only way to recover your collections.\n\nAre you sure you want to disconnect?');
        if (confirmed) {
          window.location.href = '/disconnect';
        }
      });

      // Pre-prompt functionality
      const textarea = document.getElementById('default-preprompt');
      const saveBtn = document.getElementById('save-preprompt');
      const originalValue = textarea.value;

      textarea.addEventListener('input', function() {
        saveBtn.classList.toggle('hidden', textarea.value === originalValue);
      });

      saveBtn.addEventListener('click', async function() {
        saveBtn.textContent = 'Saving...';
        try {
          const response = await fetch('/api/settings/pre-prompt', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prePrompt: textarea.value })
          });
          if (response.ok) {
            saveBtn.textContent = 'Saved!';
            setTimeout(function() {
              saveBtn.classList.add('hidden');
              saveBtn.textContent = 'Save';
            }, 1500);
          } else {
            saveBtn.textContent = 'Error';
          }
        } catch (e) {
          saveBtn.textContent = 'Error';
        }
      });
    })();
