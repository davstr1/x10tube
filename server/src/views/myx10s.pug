extends layout

block content
  //- Hidden element for extension to read user code
  div(data-x10-user-code=userCode style="display:none")

  style.
    .dropdown { position: relative; }
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 50;
      min-width: 10rem;
      padding-top: 0.25rem;
    }
    .dropdown-menu-inner {
      background: var(--color-surface);
      border: 1px solid var(--color-border-strong);
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      padding: 0.25rem 0;
    }
    .dropdown-menu-inner button,
    .dropdown-menu-inner a {
      text-align: left !important;
    }
    .dropdown:hover .dropdown-menu { display: block; }

  .flex.justify-between.items-center.mb-8
    h1.text-2xl.font-semibold.text-text-primary My collections
    a.bg-red-600.hover_bg-red-700.text-white.px-4.py-2.rounded-md.text-sm.font-medium.no-underline(href="/") + New

  //- Main content: X10s list
  if x10s && x10s.length > 0
    .space-y-4.mb-12
      each x10 in x10s
        - const tokenDisplay = x10.tokenCount > 1000 ? `${Math.round(x10.tokenCount / 1000)}K tokens` : `${x10.tokenCount} tokens`
        - const date = new Date(x10.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
        - const firstItem = x10.videos[0]
        - const isFirstYouTube = firstItem && (firstItem.type === 'youtube' || firstItem.youtube_id)
        - const thumbnailUrl = isFirstYouTube ? `https://img.youtube.com/vi/${firstItem.youtube_id}/mqdefault.jpg` : null
        - const faviconUrl = firstItem && !isFirstYouTube ? `https://www.google.com/s2/favicons?domain=${firstItem.channel}&sz=128` : null
        - const mdUrl = `${process.env.BASE_URL || 'http://localhost:3000'}/s/${x10.id}.md`
        - const x10Url = `${process.env.BASE_URL || 'http://localhost:3000'}/s/${x10.id}`
        - const effectivePrePrompt = x10.pre_prompt || settings.default_pre_prompt || ''
        - const fullPrompt = 'Fetch ' + mdUrl + '\n\n' + effectivePrePrompt
        - const encodedPrompt = encodeURIComponent(fullPrompt)

        .bg-surface.border.border-border-strong.rounded-lg.hover_border-text-muted.transition-colors
          .flex.gap-4.p-4
            //- Thumbnail (first item)
            a.flex-shrink-0.block(href=`/s/${x10.id}`)
              if thumbnailUrl
                img.w-36.h-20.object-cover.rounded-md(src=thumbnailUrl alt=x10.title || 'Untitled')
              else if faviconUrl
                .w-36.h-20.rounded-md.bg-surface-alt.flex.items-center.justify-center
                  img.w-10.h-10(src=faviconUrl alt=firstItem.channel)

            .flex-1.min-w-0
              //- Header row
              .flex.justify-between.items-start.gap-2.mb-2
                div.min-w-0
                  a.block(href=`/s/${x10.id}`)
                    h3.font-semibold.text-text-primary.hover_text-red-600.transition-colors.truncate= x10.title || 'Untitled'
                  p.text-sm.text-text-secondary.mt-1
                    | #{x10.videos.length} item#{x10.videos.length > 1 ? 's' : ''}
                    span.mx-1 ·
                    | #{tokenDisplay}
                span.text-xs.text-text-muted.flex-shrink-0= date

              //- Actions row (matching x10 video item style)
              .flex.items-center.gap-3.text-xs
                a.text-text-muted.hover_text-text-secondary(href=`/s/${x10.id}`) Open

                //- Open in... dropdown
                .dropdown
                  button.text-text-muted.hover_text-text-secondary(type="button")
                    | Open in...
                    span.ml-1 ▾
                  .dropdown-menu
                    .dropdown-menu-inner
                      a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://claude.ai/new?q=${encodedPrompt}` target="_blank") Claude
                      a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://chat.openai.com/?q=${encodedPrompt}` target="_blank") ChatGPT
                      a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://www.google.com/search?udm=50&aep=11&q=${encodedPrompt}` target="_blank") Gemini
                      a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://www.perplexity.ai/search/?q=${encodedPrompt}` target="_blank") Perplexity
                      a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://x.com/i/grok?text=${encodedPrompt}` target="_blank") Grok
                      a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://copilot.microsoft.com/?q=${encodedPrompt}` target="_blank") Copilot

                //- Copy... dropdown
                .dropdown
                  button.text-text-muted.hover_text-text-secondary(type="button")
                    | Copy...
                    span.ml-1 ▾
                  .dropdown-menu
                    .dropdown-menu-inner
                      button.block.w-full.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover(
                        type="button"
                        onclick=`navigator.clipboard.writeText('${mdUrl}'); this.textContent='Copied!'; setTimeout(() => this.textContent='MD Link', 1500)`
                      ) MD Link
                      button.block.w-full.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.copy-md-content-btn(
                        type="button"
                        data-md-url=mdUrl
                      ) MD Content
                      button.block.w-full.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover(
                        type="button"
                        onclick=`navigator.clipboard.writeText('${x10Url}'); this.textContent='Copied!'; setTimeout(() => this.textContent='Share URL', 1500)`
                      ) Share URL

                //- Spacer to push delete to the right
                .flex-1

                //- Delete button (right-aligned)
                form.inline(action=`/x10/${x10.id}/delete` method="POST" style="display:inline")
                  button.w-6.h-6.flex.items-center.justify-center.text-text-muted.hover_text-red-500.hover_bg-red-500.hover_bg-opacity-10.rounded-full.transition-colors(type="submit" onclick="return confirm('Delete this collection?')") ×

  else
    .text-center.py-16.mb-12
      p.text-text-secondary.mb-6 You don't have any collections yet
      a.bg-red-600.hover_bg-red-700.text-white.px-6.py-3.rounded-md.text-sm.font-medium.no-underline(href="/")
        | Create my first collection

      p.mt-8.text-text-secondary or

      p.mt-4.text-sm.text-text-secondary
        | Install the Chrome extension
        br
        | Add videos in one click from YouTube

  //- Settings section (bottom)
  section.border-t.border-border-strong.pt-8
    h2.text-lg.font-semibold.text-text-primary.mb-6 Settings

    //- Default prompt
    .bg-surface.border.border-border-strong.rounded-lg.p-4.mb-6
      .flex.justify-between.items-center.mb-2
        p.text-sm.text-text-secondary Default prompt
        button#save-preprompt.text-xs.text-red-600.hover_text-red-700.hidden(type="button") Save
      textarea#default-preprompt.w-full.px-3.py-2.border.border-border-strong.rounded-md.text-sm.focus_outline-none.focus_border-text-muted.resize-none.bg-surface.text-text-primary(
        rows="2"
        placeholder="Summarize the content. What do we learn?"
      )= settings.default_pre_prompt
      p.text-xs.text-text-muted.mt-2 Instructions sent to the LLM after fetching the content

    //- User code section
    .bg-surface.border.border-border-strong.rounded-lg.p-4
      .flex.justify-between.items-center
        div
          p.text-sm.text-text-secondary.mb-1 Your user code
          .flex.items-center.gap-2
            code#user-code-display.text-sm.font-mono.text-text-primary.bg-surface-alt.px-2.py-1.rounded ••••••••••••••••
            button#toggle-code.text-text-muted.hover_text-text-secondary(
              type="button"
              title="Show code"
              style="padding: 4px;"
            )
              //- Eye open (show when hidden)
              svg#eye-open(fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z")
              //- Eye closed/slashed (show when visible)
              svg#eye-closed(fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px; display: none;")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21")
            button#copy-code.text-xs.text-red-600.hover_text-red-700(
              type="button"
            ) Copy
        .flex.items-center.gap-4
          a.text-sm.text-text-secondary.hover_text-text-primary(href="/sync") Sync from another device
          button#disconnect-btn.text-sm.text-text-muted.hover_text-red-600(type="button") Disconnect

  script.
    (function() {
      // User code functionality
      const userCode = '#{userCode}';
      const display = document.getElementById('user-code-display');
      const toggleBtn = document.getElementById('toggle-code');
      const copyBtn = document.getElementById('copy-code');
      const eyeOpen = document.getElementById('eye-open');
      const eyeClosed = document.getElementById('eye-closed');
      let visible = false;

      toggleBtn.addEventListener('click', function() {
        visible = !visible;
        display.textContent = visible ? userCode : '••••••••••••••••';
        toggleBtn.title = visible ? 'Hide code' : 'Show code';
        eyeOpen.style.display = visible ? 'none' : 'block';
        eyeClosed.style.display = visible ? 'block' : 'none';
      });

      copyBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(userCode);
        copyBtn.textContent = 'Copied!';
        setTimeout(function() { copyBtn.textContent = 'Copy'; }, 1500);
      });

      var disconnectBtn = document.getElementById('disconnect-btn');
      disconnectBtn.addEventListener('click', function() {
        var confirmed = confirm('Warning: Make sure you have saved your user code!\n\nThis is the only way to recover your collections.\n\nAre you sure you want to disconnect?');
        if (confirmed) {
          window.location.href = '/disconnect';
        }
      });

      // Pre-prompt functionality
      const textarea = document.getElementById('default-preprompt');
      const saveBtn = document.getElementById('save-preprompt');
      const originalValue = textarea.value;

      textarea.addEventListener('input', function() {
        saveBtn.classList.toggle('hidden', textarea.value === originalValue);
      });

      saveBtn.addEventListener('click', async function() {
        saveBtn.textContent = 'Saving...';
        try {
          const response = await fetch('/api/settings/pre-prompt', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prePrompt: textarea.value })
          });
          if (response.ok) {
            saveBtn.textContent = 'Saved!';
            setTimeout(function() {
              saveBtn.classList.add('hidden');
              saveBtn.textContent = 'Save';
            }, 1500);
          } else {
            saveBtn.textContent = 'Error';
          }
        } catch (e) {
          saveBtn.textContent = 'Error';
        }
      });

      // Copy MD Content functionality
      document.querySelectorAll('.copy-md-content-btn').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          const mdUrl = btn.dataset.mdUrl;
          try {
            const response = await fetch(mdUrl);
            const md = await response.text();
            await navigator.clipboard.writeText(md);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'MD Content', 1500);
          } catch (e) {
            btn.textContent = 'Error';
            setTimeout(() => btn.textContent = 'MD Content', 1500);
          }
        });
      });
    })();
