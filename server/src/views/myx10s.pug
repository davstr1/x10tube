extends layout
include mixins/extension-required

block content
  //- Hidden element for extension to read user code
  div(data-x10-user-code=userCode style="display:none")

  +extensionRequired()

  style.
    .dropdown { position: relative; }
    .dropdown:hover { z-index: 100; }
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 100;
      min-width: 10rem;
      padding-top: 0.25rem;
    }
    .dropdown-menu-inner {
      background: var(--color-surface);
      border: 1px solid var(--color-border-strong);
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      padding: 0.25rem 0;
    }
    .dropdown-menu-inner button,
    .dropdown-menu-inner a {
      text-align: left !important;
    }
    .dropdown:hover .dropdown-menu { display: block; }

  .flex.justify-between.items-center.mb-8
    h1.text-2xl.font-semibold.text-text-primary.flex.items-center.gap-3
      svg.text-text-muted(viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:28px;height:28px;")
        polygon(points="12 2 2 7 12 12 22 7 12 2")
        polyline(points="2 17 12 22 22 17")
        polyline(points="2 12 12 17 22 12")
      | My collections
    a.bg-red-600.hover_bg-red-700.text-white.px-4.py-2.rounded-md.text-sm.font-medium.no-underline(href="/welcome") + New

  //- Main content: X10s list
  if x10s && x10s.length > 0
    .space-y-4.mb-12
      each x10 in x10s
        - const tokenDisplay = x10.tokenCount > 1000 ? `${Math.round(x10.tokenCount / 1000)}K tokens` : `${x10.tokenCount} tokens`
        - const date = new Date(x10.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
        - const firstItem = x10.items[0]
        - const isFirstYouTube = firstItem && firstItem.source_type === 'youtube'
        - const thumbnailUrl = isFirstYouTube ? `https://img.youtube.com/vi/${firstItem.source_id}/mqdefault.jpg` : null
        - const faviconUrl = firstItem && !isFirstYouTube ? `https://www.google.com/s2/favicons?domain=${firstItem.channel}&sz=128` : null
        - const mdUrl = `${baseUrl}/s/${x10.id}.md`
        - const x10Url = `${baseUrl}/s/${x10.id}`
        - const effectivePrePrompt = x10.pre_prompt || settings.default_pre_prompt || ''
        - const fullPrompt = 'Fetch ' + mdUrl + '\n\n' + effectivePrePrompt
        - const encodedPrompt = encodeURIComponent(fullPrompt)

        .bg-surface.border.border-border-strong.rounded-lg.hover_border-text-muted.transition-colors
          .flex.gap-4.p-4
            //- Thumbnail (first item)
            a.flex-shrink-0.block(href=`/s/${x10.id}`)
              if thumbnailUrl
                img.w-36.h-20.object-cover.rounded-md(src=thumbnailUrl alt=x10.title || 'Untitled')
              else if faviconUrl
                .w-36.h-20.rounded-md.bg-surface-alt.flex.items-center.justify-center
                  img.w-10.h-10(src=faviconUrl alt=firstItem.channel)

            .flex-1.min-w-0
              //- Header row
              .flex.justify-between.items-start.gap-2.mb-2
                div.min-w-0
                  a.block(href=`/s/${x10.id}`)
                    h3.font-semibold.text-text-primary.hover_text-red-600.transition-colors.truncate= x10.title || 'Untitled'
                  p.text-sm.text-text-secondary.mt-1
                    | #{x10.items.length} item#{x10.items.length > 1 ? 's' : ''}
                    span.mx-1 ·
                    | #{tokenDisplay}
                span.text-xs.text-text-muted.flex-shrink-0= date

              //- Actions row (matching x10 video item style)
              .flex.items-center.gap-3.text-xs
                a.text-text-muted.hover_text-text-secondary(href=`/s/${x10.id}`) Open

                //- Open in... dropdown
                .dropdown
                  button.text-text-muted.hover_text-text-secondary(type="button")
                    | Open in...
                    span.ml-1 ▾
                  .dropdown-menu
                    .dropdown-menu-inner
                      a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://claude.ai/new?q=${encodedPrompt}` target="_blank") Claude
                      a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://chat.openai.com/?q=${encodedPrompt}` target="_blank") ChatGPT
                      button.block.w-full.text-left.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.clipboard-llm-btn(
                        type="button"
                        data-llm="gemini"
                        data-llm-url="https://gemini.google.com/app"
                        data-md-url=mdUrl
                      ) Gemini#[span.text-text-muted *]
                      button.block.w-full.text-left.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.clipboard-llm-btn(
                        type="button"
                        data-llm="perplexity"
                        data-llm-url="https://www.perplexity.ai/"
                        data-md-url=mdUrl
                      ) Perplexity#[span.text-text-muted *]
                      a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://x.com/i/grok?text=${encodedPrompt}` target="_blank") Grok
                      a.block.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.no-underline(href=`https://copilot.microsoft.com/?q=${encodedPrompt}` target="_blank") Copilot
                      .px-3.py-1.text-xs.text-text-muted.border-t.border-border-default.mt-1 * Clipboard mode

                //- Copy... dropdown
                .dropdown
                  button.text-text-muted.hover_text-text-secondary(type="button")
                    | Copy...
                    span.ml-1 ▾
                  .dropdown-menu
                    .dropdown-menu-inner
                      button.block.w-full.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover(
                        type="button"
                        onclick=`navigator.clipboard.writeText('${mdUrl}'); this.textContent='Copied!'; setTimeout(() => this.textContent='Link', 1500)`
                      ) Link
                      button.block.w-full.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.copy-md-content-btn(
                        type="button"
                        data-md-url=mdUrl
                      ) MD Content

                //- Spacer to push delete to the right
                .flex-1

                //- Delete button (right-aligned)
                form.inline(action=`/x10/${x10.id}/delete` method="POST" style="display:inline")
                  button.w-6.h-6.flex.items-center.justify-center.text-text-muted.hover_text-red-500.hover_bg-red-500.hover_bg-opacity-10.rounded-full.transition-colors(type="submit" onclick="return confirm('Delete this collection?')") ×

  else
    .text-center.py-16.mb-12
      p.text-text-secondary.mb-6 You don't have any collections yet
      a.bg-red-600.hover_bg-red-700.text-white.px-6.py-3.rounded-md.text-sm.font-medium.no-underline(href="/welcome")
        | Create my first collection

      p.mt-8.text-text-secondary or

      p.mt-4.text-sm.text-text-secondary
        | Install the Chrome extension
        br
        | Add videos in one click from YouTube

  script.
    (function() {
      // Copy MD Content functionality
      document.querySelectorAll('.copy-md-content-btn').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          const mdUrl = btn.dataset.mdUrl;
          try {
            const response = await fetch(mdUrl);
            const md = await response.text();
            await navigator.clipboard.writeText(md);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'MD Content', 1500);
          } catch (e) {
            btn.textContent = 'Error';
            setTimeout(() => btn.textContent = 'MD Content', 1500);
          }
        });
      });

      // Clipboard-only LLM handling (Gemini, Perplexity)
      const LLM_NAMES = { gemini: 'Gemini', perplexity: 'Perplexity' };

      function showClipboardModal(llmName, mdUrl, llmUrl) {
        const existing = document.getElementById('clipboard-modal');
        if (existing) existing.remove();

        const modal = document.createElement('div');
        modal.id = 'clipboard-modal';
        modal.innerHTML = `
          <div class="modal-backdrop"></div>
          <div class="modal-content">
            <div class="modal-header">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              <span>Clipboard Mode</span>
            </div>
            <div class="modal-body">
              <p><strong>${llmName}</strong> doesn't currently support fetching external links. This is a limitation on their side, not ours.</p>
              <p>Instead, we'll copy your content to the clipboard. Just paste it (Ctrl+V) once ${llmName} opens.</p>
            </div>
            <div class="modal-actions">
              <button class="modal-btn-primary" id="modal-confirm">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Copy & Open ${llmName}
              </button>
              <button class="modal-btn-secondary" id="modal-cancel">Cancel</button>
            </div>
            <label class="modal-dismiss">
              <input type="checkbox" id="modal-dismiss-checkbox">
              <span>Got it, don't show again</span>
            </label>
          </div>
        `;
        document.body.appendChild(modal);

        document.getElementById('modal-confirm').addEventListener('click', async function() {
          const dismiss = document.getElementById('modal-dismiss-checkbox').checked;
          if (dismiss) {
            localStorage.setItem(llmName.toLowerCase() + 'WarningDismissed', 'true');
          }
          modal.remove();
          await copyAndOpen(mdUrl, llmUrl);
        });

        document.getElementById('modal-cancel').addEventListener('click', function() {
          modal.remove();
        });

        modal.querySelector('.modal-backdrop').addEventListener('click', function() {
          modal.remove();
        });

        function handleEscape(e) {
          if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', handleEscape);
          }
        }
        document.addEventListener('keydown', handleEscape);
      }

      async function copyAndOpen(mdUrl, llmUrl) {
        try {
          const response = await fetch(mdUrl);
          const content = await response.text();
          await navigator.clipboard.writeText(content);
          window.open(llmUrl, '_blank');
          showToast('Content copied — paste it!');
        } catch (e) {
          console.error('Error copying content:', e);
        }
      }

      function showToast(message) {
        const existing = document.getElementById('clipboard-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.id = 'clipboard-toast';
        toast.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
          ${message}
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      document.querySelectorAll('.clipboard-llm-btn').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          const llm = btn.dataset.llm;
          const llmUrl = btn.dataset.llmUrl;
          const mdUrl = btn.dataset.mdUrl;
          const llmName = LLM_NAMES[llm] || llm;
          const dismissed = localStorage.getItem(llm + 'WarningDismissed') === 'true';

          if (dismissed) {
            await copyAndOpen(mdUrl, llmUrl);
          } else {
            showClipboardModal(llmName, mdUrl, llmUrl);
          }
        });
      });
    })();

  //- Modal and Toast styles
  style.
    #clipboard-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #clipboard-modal .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
    }
    #clipboard-modal .modal-content {
      position: relative;
      background: var(--color-surface);
      border: 1px solid var(--color-border-strong);
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.3);
      animation: modal-in 0.2s ease-out;
    }
    @keyframes modal-in {
      from { opacity: 0; transform: scale(0.95) translateY(-10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    #clipboard-modal .modal-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      color: var(--color-text-muted);
      font-size: 14px;
      font-weight: 600;
    }
    #clipboard-modal .modal-body {
      color: var(--color-text-secondary);
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 20px;
    }
    #clipboard-modal .modal-body p {
      margin: 0 0 12px 0;
    }
    #clipboard-modal .modal-body p:last-child {
      margin-bottom: 0;
    }
    #clipboard-modal .modal-body strong {
      color: var(--color-text-primary);
    }
    #clipboard-modal .modal-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    #clipboard-modal .modal-btn-primary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--color-surface-hover);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border-strong);
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      flex: 1;
    }
    #clipboard-modal .modal-btn-primary:hover {
      background: var(--color-border-strong);
    }
    #clipboard-modal .modal-btn-secondary {
      background: transparent;
      color: var(--color-text-muted);
      border: 1px solid var(--color-border-strong);
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    #clipboard-modal .modal-btn-secondary:hover {
      background: var(--color-surface-hover);
      color: var(--color-text-primary);
    }
    #clipboard-modal .modal-dismiss {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--color-text-muted);
      font-size: 12px;
      cursor: pointer;
      justify-content: flex-end;
    }
    #clipboard-modal .modal-dismiss input[type="checkbox"] {
      width: 14px;
      height: 14px;
      cursor: pointer;
    }
    #clipboard-toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #16a34a;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 9999;
      animation: toast-in 0.2s ease-out;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
