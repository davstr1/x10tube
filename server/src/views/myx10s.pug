extends layout
include mixins/extension-required

block content
  //- Hidden element for extension to read user code
  div(data-x10-user-code=userCode style="display:none")

  +extensionRequired()

  style.
    .dropdown { position: relative; }
    .dropdown:hover { z-index: 100; }
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 100;
      min-width: 10rem;
      padding-top: 0.25rem;
    }
    .dropdown-menu-inner {
      background: var(--color-surface);
      border: 1px solid var(--color-border-strong);
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      padding: 0.25rem 0;
    }
    .dropdown-menu-inner button,
    .dropdown-menu-inner a {
      text-align: left !important;
    }
    .dropdown:hover .dropdown-menu { display: block; }

  .flex.justify-between.items-center.mb-8
    h1.text-2xl.font-semibold.text-text-primary.flex.items-center.gap-3
      svg.text-text-muted(viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:28px;height:28px;")
        polygon(points="12 2 2 7 12 12 22 7 12 2")
        polyline(points="2 17 12 22 22 17")
        polyline(points="2 12 12 17 22 12")
      | My collections
    a.bg-red-600.hover_bg-red-700.text-white.px-4.py-2.rounded-md.text-sm.font-medium.no-underline(href="/welcome") + New

  //- Main content: X10s list
  if x10s && x10s.length > 0
    #collections-list.space-y-4.mb-12(data-page=currentPage data-has-more=hasMore data-base-url=baseUrl)
      each x10 in x10s
        - const tokenDisplay = x10.tokenCount > 1000 ? `${Math.round(x10.tokenCount / 1000)}K tokens` : `${x10.tokenCount} tokens`
        - const date = new Date(x10.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
        - const firstItem = x10.items[0]
        - const isFirstYouTube = firstItem && firstItem.source_type === 'youtube'
        - const thumbnailUrl = isFirstYouTube ? `https://img.youtube.com/vi/${firstItem.source_id}/mqdefault.jpg` : null
        - const faviconUrl = firstItem && !isFirstYouTube ? `https://www.google.com/s2/favicons?domain=${firstItem.channel}&sz=128` : null
        - const mdUrl = `${baseUrl}/s/${x10.id}.txt`
        - const x10Url = `${baseUrl}/s/${x10.id}`

        .bg-surface.border.border-border-strong.rounded-lg.hover_border-text-muted.transition-colors
          .flex.gap-4.p-4
            //- Thumbnail (first item)
            a.flex-shrink-0.block(href=`/s/${x10.id}`)
              if thumbnailUrl
                img.w-36.h-20.object-cover.rounded-md(src=thumbnailUrl alt=x10.title || 'Untitled')
              else if faviconUrl
                .w-36.h-20.rounded-md.bg-surface-alt.flex.items-center.justify-center
                  img.w-10.h-10(src=faviconUrl alt=firstItem.channel)

            .flex-1.min-w-0
              //- Header row
              .flex.justify-between.items-start.gap-2.mb-2
                div.min-w-0
                  a.block(href=`/s/${x10.id}`)
                    h3.font-semibold.text-text-primary.hover_text-red-600.transition-colors.truncate= x10.title || 'Untitled'
                  p.text-sm.text-text-secondary.mt-1
                    | #{x10.items.length} item#{x10.items.length > 1 ? 's' : ''}
                    span.mx-1 ·
                    | #{tokenDisplay}
                span.text-xs.text-text-muted.flex-shrink-0= date

              //- Actions row (matching x10 video item style)
              .flex.items-center.gap-3.text-xs
                a.text-text-muted.hover_text-text-secondary(href=`/s/${x10.id}`) Open

                //- Open in... dropdown
                .dropdown
                  button.text-text-muted.hover_text-text-secondary(type="button")
                    | Open in...
                    span.ml-1 ▾
                  .dropdown-menu
                    .dropdown-menu-inner
                      button.block.w-full.text-left.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.flex.items-center.gap-2(
                        type="button"
                        data-stya-open-in="chatgpt"
                        data-stya-md-url=mdUrl
                      )
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="#10A37F"><path d="M14.813 6.344a3.7 3.7 0 0 0-.318-3.048 3.74 3.74 0 0 0-4.036-1.778A3.7 3.7 0 0 0 7.672.25a3.74 3.74 0 0 0-3.57 2.6 3.7 3.7 0 0 0-2.477 1.792 3.74 3.74 0 0 0 .46 4.378 3.7 3.7 0 0 0 .318 3.048 3.74 3.74 0 0 0 4.036 1.779 3.7 3.7 0 0 0 2.786 1.247 3.74 3.74 0 0 0 3.571-2.6 3.7 3.7 0 0 0 2.478-1.793 3.74 3.74 0 0 0-.461-4.377M8.321 14.18a2.78 2.78 0 0 1-1.786-.65c.023-.012.062-.035.088-.05l2.966-1.713a.48.48 0 0 0 .244-.422V7.102l1.254.724a.04.04 0 0 1 .023.033v3.463a2.79 2.79 0 0 1-2.789 2.79zM2.194 11.6a2.77 2.77 0 0 1-.332-1.87l.088.053 2.966 1.713a.48.48 0 0 0 .487 0l3.623-2.092v1.448a.05.05 0 0 1-.019.04L5.98 12.627a2.79 2.79 0 0 1-3.814-1.027zm-.803-6.477a2.78 2.78 0 0 1 1.454-1.22v3.527a.48.48 0 0 0 .243.42l3.622 2.093-1.253.724a.04.04 0 0 1-.042.004L2.388 8.936a2.79 2.79 0 0 1-1.026-3.813zm10.538 2.455L8.306 5.485l1.254-.723a.04.04 0 0 1 .042-.004l3.027 1.748a2.79 2.79 0 0 1-.431 5.032V8.012a.48.48 0 0 0-.24-.421zm1.248-1.882a3 3 0 0 0-.088-.052L10.123 3.93a.48.48 0 0 0-.487 0L6.013 6.022V4.574a.05.05 0 0 1 .02-.04l3.026-1.748a2.79 2.79 0 0 1 4.146 2.882zM5.314 8.898l-1.254-.724a.04.04 0 0 1-.022-.034V4.677a2.79 2.79 0 0 1 4.574-2.14l-.088.05L5.558 4.3a.48.48 0 0 0-.244.422zm.68-1.466L8 6.326l2.006 1.158v2.316L8 10.958 5.994 9.8z"/></svg>
                        | ChatGPT
                      button.block.w-full.text-left.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.flex.items-center.gap-2(
                        type="button"
                        data-stya-open-in="claude"
                        data-stya-md-url=mdUrl
                      )
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="#D4A27F"><path d="M11.64 6.353a.75.75 0 0 1-.14 1.052L8.3 9.963a.75.75 0 0 1-.912 0L4.5 7.405a.75.75 0 0 1 .912-1.192l2.744 2.098 2.744-2.098a.75.75 0 0 1 1.052.14z"/><path fill-rule="evenodd" d="M7.156.25a2.843 2.843 0 0 0-2.156.99L3.378 3.19a.75.75 0 0 1-.564.26H1.75a1.5 1.5 0 0 0-1.5 1.5v8.3a2.5 2.5 0 0 0 2.5 2.5h10.5a2.5 2.5 0 0 0 2.5-2.5v-8.3a1.5 1.5 0 0 0-1.5-1.5h-1.057a.75.75 0 0 1-.57-.26L10.99 1.24a2.84 2.84 0 0 0-2.146-.99zM6.13 2.104a1.34 1.34 0 0 1 1.018-.467h1.692c.39 0 .763.17 1.02.467l1.62 1.949a2.25 2.25 0 0 0 1.71.78h1.06v8.417a1 1 0 0 1-1 1H2.75a1 1 0 0 1-1-1V4.833h1.064a2.25 2.25 0 0 0 1.697-.78z" clip-rule="evenodd"/></svg>
                        | Claude
                      button.block.w-full.text-left.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.flex.items-center.gap-2(
                        type="button"
                        data-stya-open-in="copilot"
                        data-stya-md-url=mdUrl
                      )
                        <svg width="12" height="12" viewBox="0 0 16 16"><defs><linearGradient id="copilot-grad-s" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#0078D4"/><stop offset="100%" style="stop-color:#00BCF2"/></linearGradient></defs><path fill="url(#copilot-grad-s)" d="M7.462 0H0v7.19h7.462zM16 0H8.538v7.19H16zM7.462 8.211H0V16h7.462zm8.538 0H8.538V16H16z"/></svg>
                        | Copilot
                      button.block.w-full.text-left.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.flex.items-center.gap-2(
                        type="button"
                        data-stya-open-in="gemini"
                        data-stya-md-url=mdUrl
                      )
                        <svg width="12" height="12" viewBox="0 0 16 16"><defs><linearGradient id="gemini-grad-s" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#4285F4"/><stop offset="50%" style="stop-color:#9B72CB"/><stop offset="100%" style="stop-color:#D96570"/></linearGradient></defs><path fill="url(#gemini-grad-s)" d="M15.545 6.558a9.4 9.4 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.7 7.7 0 0 1 5.352 2.082l-2.284 2.284A4.35 4.35 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.8 4.8 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.7 3.7 0 0 0 1.599-2.431H8v-3.08z"/></svg>
                        | Gemini
                        span.text-text-muted *
                      button.block.w-full.text-left.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.flex.items-center.gap-2(
                        type="button"
                        data-stya-open-in="grok"
                        data-stya-md-url=mdUrl
                      )
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865z"/></svg>
                        | Grok
                      button.block.w-full.text-left.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.flex.items-center.gap-2(
                        type="button"
                        data-stya-open-in="perplexity"
                        data-stya-md-url=mdUrl
                      )
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="#1FB8CD"><path d="M5.333 1.333v4L1.667 2.5v11l3.666-2.833v4l3-2.25V16h.334v-3.583l3 2.25v-4l3.666 2.833v-11L12.667 5.333v-4l-3 2.25V0h-.334v3.583zM12 5.75v4.5l3-2.25zM5.667 5.687v4.626L3 12.375V3.625zM6.333 5.75l2.334 1.75v5l-2.334-1.75zm3 1.75l2.334-1.75v5l-2.334 1.75zM6 2v2.563L3.665 2.5 6 1.333zm0 11.5v.667l-2.335-1.75L6 10.688zM10 2v2.563l2.335-2.063L10 1.333zm0 11.5v.667l2.335-1.75L10 10.688z"/></svg>
                        | Perplexity
                        span.text-text-muted *
                      .px-3.py-1.text-xs.text-text-muted.border-t.border-border-default.mt-1 * Clipboard mode

                //- Copy... dropdown
                .dropdown
                  button.text-text-muted.hover_text-text-secondary(type="button")
                    | Copy...
                    span.ml-1 ▾
                  .dropdown-menu
                    .dropdown-menu-inner
                      button.block.w-full.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.flex.items-center.gap-1(
                        type="button"
                        onclick=`navigator.clipboard.writeText('${mdUrl}'); this.querySelector('span').textContent='Copied!'; setTimeout(() => this.querySelector('span').textContent='Link', 1500)`
                      )
                        svg(width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round")
                          path(d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71")
                          path(d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71")
                        span Link
                      button.block.w-full.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.copy-md-content-btn.flex.items-center.gap-1(
                        type="button"
                        data-md-url=mdUrl
                      )
                        svg(width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round")
                          rect(x="9" y="9" width="13" height="13" rx="2" ry="2")
                          path(d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1")
                        span Copy MD
                      button.block.w-full.px-3.py-1.text-xs.text-text-primary.hover_bg-surface-hover.download-md-btn.flex.items-center.gap-1(
                        type="button"
                        data-md-url=mdUrl
                        data-title=x10.title
                      )
                        svg(width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round")
                          path(d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4")
                          polyline(points="7 10 12 15 17 10")
                          line(x1="12" y1="15" x2="12" y2="3")
                        span Download MD

                //- Spacer to push delete to the right
                .flex-1

                //- Delete button (right-aligned)
                form.inline(action=`/x10/${x10.id}/delete` method="POST" style="display:inline")
                  button.w-6.h-6.flex.items-center.justify-center.text-text-muted.hover_text-red-500.hover_bg-red-500.hover_bg-opacity-10.rounded-full.transition-colors(type="submit" onclick="return confirm('Delete this collection?')") ×

    //- Infinite scroll sentinel and loader
    if hasMore
      #load-more-sentinel.py-8.flex.justify-center
        .loading-spinner.hidden
          svg.animate-spin.h-6.w-6.text-text-muted(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24")
            circle.opacity-25(cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4")
            path.opacity-75(fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z")

  else
    .text-center.py-16.mb-12
      p.text-text-secondary.mb-6 You don't have any collections yet
      a.bg-red-600.hover_bg-red-700.text-white.px-6.py-3.rounded-md.text-sm.font-medium.no-underline(href="/welcome")
        | Create my first collection

      p.mt-8.text-text-secondary or

      p.mt-4.text-sm.text-text-secondary
        | Install the Chrome extension
        br
        | Add videos in one click from YouTube

  script.
    (function() {
      // Slugify for filenames
      function slugify(text) {
        return text
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '')
          .slice(0, 50);
      }

      // Download function
      function downloadAsMarkdownFile(content, title) {
        var slug = title ? slugify(title) : 'collection';
        var filename = 'stya-' + slug + '.md';
        const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      // Copy MD Content functionality
      document.querySelectorAll('.copy-md-content-btn').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          const mdUrl = btn.dataset.mdUrl;
          try {
            const response = await fetch(mdUrl);
            const md = await response.text();
            await navigator.clipboard.writeText(md);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy MD', 1500);
          } catch (e) {
            btn.textContent = 'Error';
            setTimeout(() => btn.textContent = 'Copy MD', 1500);
          }
        });
      });

      // Download MD functionality
      document.querySelectorAll('.download-md-btn').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          const mdUrl = btn.dataset.mdUrl;
          const title = btn.dataset.title;
          const originalHtml = btn.innerHTML;
          try {
            const response = await fetch(mdUrl);
            const md = await response.text();
            downloadAsMarkdownFile(md, title);
            btn.innerHTML = 'Downloaded!';
            setTimeout(() => btn.innerHTML = originalHtml, 1500);
          } catch (e) {
            btn.innerHTML = 'Error';
            setTimeout(() => btn.innerHTML = originalHtml, 1500);
          }
        });
      });

      // Infinite scroll
      (function() {
        const list = document.getElementById('collections-list');
        const sentinel = document.getElementById('load-more-sentinel');
        if (!list || !sentinel) return;

        let currentPage = parseInt(list.dataset.page) || 1;
        let hasMore = list.dataset.hasMore === 'true';
        let isLoading = false;
        const baseUrl = list.dataset.baseUrl;

        const spinner = sentinel.querySelector('.loading-spinner');

        function createCollectionCard(x10) {
          const tokenDisplay = x10.tokenCount > 1000
            ? Math.round(x10.tokenCount / 1000) + 'K tokens'
            : x10.tokenCount + ' tokens';
          const date = new Date(x10.updatedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          const firstItem = x10.firstItem;
          const isFirstYouTube = firstItem && firstItem.source_type === 'youtube';
          const thumbnailUrl = isFirstYouTube ? 'https://img.youtube.com/vi/' + firstItem.source_id + '/mqdefault.jpg' : null;
          const faviconUrl = firstItem && !isFirstYouTube ? 'https://www.google.com/s2/favicons?domain=' + firstItem.channel + '&sz=128' : null;
          const mdUrl = baseUrl + '/s/' + x10.id + '.txt';

          let thumbnailHtml = '';
          if (thumbnailUrl) {
            thumbnailHtml = '<img class="w-36 h-20 object-cover rounded-md" src="' + thumbnailUrl + '" alt="' + (x10.title || 'Untitled') + '">';
          } else if (faviconUrl) {
            thumbnailHtml = '<div class="w-36 h-20 rounded-md bg-surface-alt flex items-center justify-center"><img class="w-10 h-10" src="' + faviconUrl + '" alt=""></div>';
          }

          const card = document.createElement('div');
          card.className = 'bg-surface border border-border-strong rounded-lg hover_border-text-muted transition-colors';
          card.innerHTML = `
            <div class="flex gap-4 p-4">
              <a class="flex-shrink-0 block" href="/s/${x10.id}">${thumbnailHtml}</a>
              <div class="flex-1 min-w-0">
                <div class="flex justify-between items-start gap-2 mb-2">
                  <div class="min-w-0">
                    <a class="block" href="/s/${x10.id}">
                      <h3 class="font-semibold text-text-primary hover_text-red-600 transition-colors truncate">${x10.title || 'Untitled'}</h3>
                    </a>
                    <p class="text-sm text-text-secondary mt-1">${x10.itemCount} item${x10.itemCount > 1 ? 's' : ''} · ${tokenDisplay}</p>
                  </div>
                  <span class="text-xs text-text-muted flex-shrink-0">${date}</span>
                </div>
                <div class="flex items-center gap-3 text-xs">
                  <a class="text-text-muted hover_text-text-secondary" href="/s/${x10.id}">Open</a>
                  <a class="text-text-muted hover_text-text-secondary" href="/s/${x10.id}">View</a>
                </div>
              </div>
            </div>
          `;
          return card;
        }

        async function loadMore() {
          if (isLoading || !hasMore) return;
          isLoading = true;
          spinner.classList.remove('hidden');

          try {
            const response = await fetch('/api/collections?page=' + (currentPage + 1));
            const data = await response.json();

            data.collections.forEach(function(x10) {
              const card = createCollectionCard(x10);
              list.insertBefore(card, sentinel);
            });

            currentPage = data.page;
            hasMore = data.hasMore;
            list.dataset.page = currentPage;
            list.dataset.hasMore = hasMore;

            if (!hasMore) {
              sentinel.remove();
            }
          } catch (e) {
            console.error('Failed to load more collections:', e);
          } finally {
            isLoading = false;
            spinner.classList.add('hidden');
          }
        }

        const observer = new IntersectionObserver(function(entries) {
          if (entries[0].isIntersecting && hasMore && !isLoading) {
            loadMore();
          }
        }, { rootMargin: '100px' });

        observer.observe(sentinel);
      })();
    })();
