extends layout

block content
  section.mb-12
    if error
      .bg-red-900.dark_bg-red-950.border.border-red-700.rounded-md.p-4.mb-6.text-red-200.text-sm
        p= error
        if failedUrls && failedUrls.length > 0
          ul.mt-2.list-disc.list-inside
            each fail in failedUrls
              li #{fail.url}: #{fail.error}

    form(action="/create" method="POST")
      textarea.w-full.px-3.py-2.border.border-border-strong.rounded-md.text-base.focus_outline-none.focus_border-text-muted.resize-none.font-mono.text-sm.bg-surface.text-text-primary(
        name="urls"
        rows="5"
        placeholder="https://youtube.com/watch?v=...\nhttps://example.com/article\n(one URL per line)"
        required
      )
      button#submit-btn.mt-4.w-full.bg-red-600.hover_bg-red-700.text-white.px-4.py-3.rounded-md.text-sm.font-medium(type="submit")
        | Extract &amp; Combine...

    p.mt-4.text-sm.text-text-secondary.text-center
      | or install the #[a.text-red-600.underline(href="#extension") Chrome extension] to collect as you browse

  section.py-8.border-t.border-border-strong
    p.text-lg.text-text-secondary.mb-2
      | Pages. Videos. To your AI.
    p.text-text-muted
      | Fast. Free. No signup.

  section.py-8.border-t.border-border-strong
    h2.text-xl.font-semibold.mb-4 Why?
    ul.space-y-2.text-text-secondary
      li No awkward integrated chat â€” just use your tools
      li Works with any assistant
      li Easy to share

  section.py-8.border-t.border-border-strong
    h2.text-xl.font-semibold.mb-4 How it works
    ol.space-y-2.text-text-secondary.list-decimal.list-inside
      li Paste URLs (pages, videos, articles)
      li Get a clean markdown compilation
      li Open it in your AI

  section.py-8.border-t.border-border-strong
    h2.text-xl.font-semibold.mb-4 FAQ

    .space-y-4
      div
        h3.font-medium Is it free?
        p.text-text-secondary Yes.

      div
        h3.font-medium Does it work with Claude/ChatGPT/...?
        p.text-text-secondary Yes, and with any AI. Use "Open in..." or copy-paste the content.

      div
        h3.font-medium How many items max?
        p.text-text-secondary
          | As many as your AI can handle. Claude reads ~100K tokens. We show an estimate on each collection.

      div
        h3.font-medium Is my data stored?
        p.text-text-secondary Collections are public. Log in to edit or delete.

  script.
    (function() {
      var LLM_URLS = {
        claude: function(p) { return 'https://claude.ai/new?q=' + encodeURIComponent(p); },
        chatgpt: function(p) { return 'https://chat.openai.com/?q=' + encodeURIComponent(p); },
        gemini: function(p) { return 'https://www.google.com/search?udm=50&aep=11&q=' + encodeURIComponent(p); },
        perplexity: function(p) { return 'https://www.perplexity.ai/search/?q=' + encodeURIComponent(p); },
        grok: function(p) { return 'https://x.com/i/grok?text=' + encodeURIComponent(p); },
        copilot: function(p) { return 'https://copilot.microsoft.com/?q=' + encodeURIComponent(p); }
      };
      var LLMS = ['claude', 'chatgpt', 'gemini', 'perplexity', 'grok', 'copilot'];
      var LLM_LABELS = { claude: 'Claude', chatgpt: 'ChatGPT', gemini: 'Gemini', perplexity: 'Perplexity', grok: 'Grok', copilot: 'Copilot' };

      var form = document.querySelector('form[action="/create"]');
      var submitBtn = document.getElementById('submit-btn');
      var currentMdUrl = '';
      var currentPrompt = '';
      var popup = null;

      // Build popup DOM and append to body (so it's truly fixed-positioned)
      function buildPopup() {
        var overlay = document.createElement('div');
        overlay.id = 'creation-popup';
        overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;display:flex;align-items:flex-start;justify-content:center;padding-top:6rem;';

        var backdrop = document.createElement('div');
        backdrop.id = 'popup-backdrop';
        backdrop.style.cssText = 'position:absolute;inset:0;';
        overlay.appendChild(backdrop);

        var card = document.createElement('div');
        card.style.cssText = 'position:relative;width:100%;max-width:24rem;margin:0 1rem;background:var(--color-surface);border:1px solid var(--color-border-strong);border-radius:0.5rem;box-shadow:0 10px 25px rgba(0,0,0,0.3);overflow:hidden;';
        overlay.appendChild(card);

        // Header
        var header = document.createElement('div');
        header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;border-bottom:1px solid var(--color-border-default);';
        var headerLeft = document.createElement('div');
        var title = document.createElement('h3');
        title.id = 'popup-title';
        title.style.cssText = 'font-weight:600;color:var(--color-text-primary);';
        var meta = document.createElement('p');
        meta.id = 'popup-meta';
        meta.style.cssText = 'font-size:0.75rem;color:var(--color-text-muted);margin-top:0.25rem;';
        headerLeft.appendChild(title);
        headerLeft.appendChild(meta);
        var closeBtn = document.createElement('button');
        closeBtn.id = 'popup-close';
        closeBtn.type = 'button';
        closeBtn.innerHTML = '&times;';
        closeBtn.style.cssText = 'color:var(--color-text-muted);font-size:1.25rem;line-height:1;cursor:pointer;background:none;border:none;padding:0.25rem;';
        header.appendChild(headerLeft);
        header.appendChild(closeBtn);
        card.appendChild(header);

        // Actions
        var actions = document.createElement('div');
        actions.style.cssText = 'padding:0.5rem;';

        // Open in... button + submenu
        var openInWrap = document.createElement('div');
        openInWrap.style.cssText = 'position:relative;';
        var openInBtn = document.createElement('button');
        openInBtn.id = 'popup-open-in';
        openInBtn.type = 'button';
        openInBtn.innerHTML = '<span style="color:var(--color-text-muted)">&#9656;</span> Open in...';
        openInBtn.style.cssText = 'width:100%;display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;font-size:0.875rem;color:var(--color-text-primary);background:none;border:none;border-radius:0.375rem;cursor:pointer;text-align:left;';
        openInWrap.appendChild(openInBtn);

        var submenu = document.createElement('div');
        submenu.id = 'popup-llm-submenu';
        submenu.style.display = 'none';
        LLMS.forEach(function(llm) {
          var a = document.createElement('a');
          a.dataset.llm = llm;
          a.textContent = LLM_LABELS[llm];
          a.href = '#';
          a.target = '_blank';
          a.style.cssText = 'display:block;padding:0.5rem 0.75rem 0.5rem 2rem;font-size:0.875rem;color:var(--color-text-primary);text-decoration:none;border-radius:0.375rem;';
          submenu.appendChild(a);
        });
        openInWrap.appendChild(submenu);
        actions.appendChild(openInWrap);

        // Copy MD Link
        var copyLinkBtn = document.createElement('button');
        copyLinkBtn.id = 'popup-copy-link';
        copyLinkBtn.type = 'button';
        copyLinkBtn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDD17</span> Copy MD Link';
        copyLinkBtn.style.cssText = 'width:100%;display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;font-size:0.875rem;color:var(--color-text-primary);background:none;border:none;border-radius:0.375rem;cursor:pointer;text-align:left;';
        actions.appendChild(copyLinkBtn);

        // Copy MD Content
        var copyContentBtn = document.createElement('button');
        copyContentBtn.id = 'popup-copy-content';
        copyContentBtn.type = 'button';
        copyContentBtn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDCCB</span> Copy MD Content';
        copyContentBtn.style.cssText = 'width:100%;display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;font-size:0.875rem;color:var(--color-text-primary);background:none;border:none;border-radius:0.375rem;cursor:pointer;text-align:left;';
        actions.appendChild(copyContentBtn);
        card.appendChild(actions);

        // View collection link
        var viewWrap = document.createElement('div');
        viewWrap.style.cssText = 'padding:0.75rem 1rem;border-top:1px solid var(--color-border-default);text-align:center;';
        var viewLink = document.createElement('a');
        viewLink.id = 'popup-view-link';
        viewLink.href = '#';
        viewLink.textContent = 'View collection \u2192';
        viewLink.style.cssText = 'font-size:0.875rem;color:var(--color-red-600, #dc2626);';
        viewWrap.appendChild(viewLink);
        card.appendChild(viewWrap);

        // Failed URLs section
        var failedWrap = document.createElement('div');
        failedWrap.id = 'popup-failed';
        failedWrap.style.display = 'none';
        var failedInner = document.createElement('div');
        failedInner.style.cssText = 'padding:0.75rem 1rem;border-top:1px solid var(--color-border-default);font-size:0.75rem;color:#f87171;';
        var failedLabel = document.createElement('p');
        failedLabel.style.fontWeight = '500';
        failedLabel.textContent = 'Some URLs failed:';
        var failedList = document.createElement('ul');
        failedList.id = 'popup-failed-list';
        failedList.style.cssText = 'list-style:disc inside;margin-top:0.25rem;';
        failedInner.appendChild(failedLabel);
        failedInner.appendChild(failedList);
        failedWrap.appendChild(failedInner);
        card.appendChild(failedWrap);

        // Add hover effects via CSS
        var style = document.createElement('style');
        style.textContent = '#creation-popup button:hover, #popup-llm-submenu a:hover { background: var(--color-surface-hover); }';
        overlay.appendChild(style);

        document.body.appendChild(overlay);
        return overlay;
      }

      function showPopup() {
        if (!popup) popup = buildPopup();
        popup.style.display = 'flex';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Done \u2713';

        // Bind events each time (popup is persistent once built)
        bindPopupEvents();
      }

      var eventsBound = false;
      function bindPopupEvents() {
        if (eventsBound) return;
        eventsBound = true;

        document.getElementById('popup-close').addEventListener('click', hidePopup);
        document.getElementById('popup-backdrop').addEventListener('click', hidePopup);

        document.getElementById('popup-open-in').addEventListener('click', function() {
          var sub = document.getElementById('popup-llm-submenu');
          sub.style.display = sub.style.display === 'none' ? 'block' : 'none';
        });

        document.getElementById('popup-copy-link').addEventListener('click', function() {
          var btn = this;
          navigator.clipboard.writeText(currentMdUrl);
          var original = btn.innerHTML;
          btn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDD17</span> Copied!';
          setTimeout(function() { btn.innerHTML = original; }, 1500);
        });

        document.getElementById('popup-copy-content').addEventListener('click', function() {
          var btn = this;
          var original = btn.innerHTML;
          btn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDCCB</span> Fetching...';
          fetch(currentMdUrl)
            .then(function(r) { return r.text(); })
            .then(function(md) {
              navigator.clipboard.writeText(md);
              btn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDCCB</span> Copied!';
              setTimeout(function() { btn.innerHTML = original; }, 1500);
            })
            .catch(function() {
              btn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDCCB</span> Error';
              setTimeout(function() { btn.innerHTML = original; }, 1500);
            });
        });
      }

      function hidePopup() {
        if (popup) {
          popup.style.display = 'none';
          var sub = document.getElementById('popup-llm-submenu');
          if (sub) sub.style.display = 'none';
        }
        submitBtn.disabled = false;
        submitBtn.textContent = 'Extract & Combine...';
      }

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.textContent = 'Extracting...';
        hidePopup();

        fetch('/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
          },
          body: new URLSearchParams(new FormData(form))
        })
        .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
        .then(function(result) {
          if (!result.ok) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Extract & Combine...';
            alert(result.data.error || 'Something went wrong');
            return;
          }

          var d = result.data;
          currentMdUrl = d.mdUrl;
          currentPrompt = 'Fetch ' + d.mdUrl;

          showPopup();

          document.getElementById('popup-title').textContent = d.title;
          var tokens = d.tokenCount > 1000 ? Math.round(d.tokenCount / 1000) + 'K tokens' : d.tokenCount + ' tokens';
          document.getElementById('popup-meta').textContent = d.itemCount + ' item' + (d.itemCount > 1 ? 's' : '') + ' \u00b7 ~' + tokens;
          document.getElementById('popup-view-link').href = d.pageUrl;

          // LLM links
          document.querySelectorAll('#popup-llm-submenu a').forEach(function(a) {
            a.href = LLM_URLS[a.dataset.llm](currentPrompt);
          });

          // Failed URLs
          var failedEl = document.getElementById('popup-failed');
          if (d.failed && d.failed.length > 0) {
            var list = document.getElementById('popup-failed-list');
            list.innerHTML = '';
            d.failed.forEach(function(f) {
              var li = document.createElement('li');
              li.textContent = f.url + ': ' + f.error;
              list.appendChild(li);
            });
            failedEl.style.display = 'block';
          } else {
            failedEl.style.display = 'none';
          }
        })
        .catch(function(err) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Extract & Combine...';
          alert('Error: ' + err.message);
        });
      });
    })();
