extends layout

block content
  //- Hero
  section.mb-6.text-center
    h1.text-xl.md_text-2xl.font-semibold.text-text-primary.mb-2
      | Send any page(s) to your AI.

    p.text-sm.text-text-secondary
      | YouTube videos, articles, web pages. Combine and send to your favorite assistant.

  //- Formulaire
  section.mb-4
    form(action="/create" method="POST")
      textarea.w-full.px-3.py-2.border.border-border-strong.rounded-md.text-base.focus_outline-none.focus_border-text-muted.resize-none.font-mono.text-sm.bg-surface.text-text-primary(
        name="urls"
        rows="4"
        placeholder="https://youtube.com/watch?v=...\nhttps://example.com/article"
        required
      )
      .relative.mt-3#send-to-wrapper
        button#submit-btn.w-full.bg-red-600.hover_bg-red-700.text-white.px-4.py-3.rounded-md.text-sm.font-medium(type="button")
          | Extract, Combine &amp; Send to...
        #send-to-menu.hidden.absolute.left-0.bg-surface.border.rounded-md(style="z-index:50; padding: 1.25rem 1.5rem; box-sizing: border-box; margin-top: 0.25rem; border-color: #dc2626;")
          .flex.flex-wrap.justify-center(style="gap: 0.75rem;")
            button.send-to-item.text-sm.rounded-md.border.bg-surface.text-text-primary.hover_bg-surface-hover(type="button" data-llm="claude" style="padding: 0.5rem 1rem; border-color: rgba(220,38,38,0.35);") Claude
            button.send-to-item.text-sm.rounded-md.border.bg-surface.text-text-primary.hover_bg-surface-hover(type="button" data-llm="chatgpt" style="padding: 0.5rem 1rem; border-color: rgba(220,38,38,0.35);") ChatGPT
            button.send-to-item.text-sm.rounded-md.border.bg-surface.text-text-primary.hover_bg-surface-hover(type="button" data-llm="gemini" style="padding: 0.5rem 1rem; border-color: rgba(220,38,38,0.35);") Gemini
            button.send-to-item.text-sm.rounded-md.border.bg-surface.text-text-primary.hover_bg-surface-hover(type="button" data-llm="perplexity" style="padding: 0.5rem 1rem; border-color: rgba(220,38,38,0.35);") Perplexity
            button.send-to-item.text-sm.rounded-md.border.bg-surface.text-text-primary.hover_bg-surface-hover(type="button" data-llm="grok" style="padding: 0.5rem 1rem; border-color: rgba(220,38,38,0.35);") Grok
            button.send-to-item.text-sm.rounded-md.border.bg-surface.text-text-primary.hover_bg-surface-hover(type="button" data-llm="copilot" style="padding: 0.5rem 1rem; border-color: rgba(220,38,38,0.35);") Copilot
          .flex.items-center(style="margin-top: 1rem;")
            .flex-1.border-t.border-border-default
            .text-xs.text-text-muted(style="padding: 0 0.75rem;") or
            .flex-1.border-t.border-border-default
          .flex.justify-center(style="gap: 0.75rem; margin-top: 1rem;")
            button.send-to-item.text-xs.rounded-md.border.bg-surface.text-text-muted.hover_text-text-primary.hover_bg-surface-hover(type="button" data-action="copy-link" style="padding: 0.5rem 1rem; border-color: rgba(220,38,38,0.35);") Copy link
            button.send-to-item.text-xs.rounded-md.border.bg-surface.text-text-muted.hover_text-text-primary.hover_bg-surface-hover(type="button" data-action="copy-md" style="padding: 0.5rem 1rem; border-color: rgba(220,38,38,0.35);") Copy markdown
          if x10s && x10s.length > 0
            .flex.items-center(style="margin-top: 1rem;")
              .flex-1.border-t.border-border-default
              .text-xs.text-text-muted(style="padding: 0 0.75rem;") or
              .flex-1.border-t.border-border-default
            .text-xs.text-text-muted.text-center(style="margin-top: 0.75rem;") Add to collection
              .flex.flex-col(style="gap: 0.5rem; margin-top: 1rem;")
                each x10 in x10s
                  - var firstItem = x10.videos && x10.videos[0]
                  - var isYT = firstItem && (firstItem.type === 'youtube' || firstItem.youtube_id)
                  - var thumb = isYT ? 'https://img.youtube.com/vi/' + firstItem.youtube_id + '/default.jpg' : null
                  - var favicon = firstItem && !isYT ? 'https://www.google.com/s2/favicons?domain=' + firstItem.channel + '&sz=32' : null
                  - var itemCount = x10.videos ? x10.videos.length : 0
                  - var tokenDisplay = x10.tokenCount > 1000 ? Math.round(x10.tokenCount / 1000) + 'K tokens' : x10.tokenCount + ' tokens'
                  button.send-to-item.flex.items-center.rounded-md.border.bg-surface.text-text-primary.hover_bg-surface-hover.text-left(type="button" data-action="add-to-collection" data-collection-id=x10.id data-original-text=(x10.title || 'Untitled') style="padding: 0.4rem 0.75rem; border-color: rgba(220,38,38,0.35); gap: 0.6rem;")
                    if thumb
                      img(src=thumb style="width: 40px; height: 24px; object-fit: cover; border-radius: 3px; flex-shrink: 0;")
                    else if favicon
                      .flex.items-center.justify-center(style="width: 40px; height: 24px; flex-shrink: 0;")
                        img(src=favicon style="width: 16px; height: 16px;")
                    else
                      .bg-surface-alt.rounded(style="width: 40px; height: 24px; flex-shrink: 0;")
                    .min-w-0.flex-1
                      .text-xs.truncate= x10.title || 'Untitled'
                      .text-text-muted(style="font-size: 0.65rem;") #{itemCount} item#{itemCount > 1 ? 's' : ''} Â· #{tokenDisplay}

    if error
      .bg-red-900.border.border-red-700.rounded-md.p-3.mt-3.text-red-200.text-sm
        p= error
        if failedUrls && failedUrls.length > 0
          ul.mt-2.list-disc.list-inside
            each fail in failedUrls
              li #{fail.url}: #{fail.error}

  //- Extension + LLMs
  p.text-center.text-sm.text-text-muted.mb-2
    | Or use the
    a.text-red-600(href="https://chromewebstore.google.com/detail/toyourai/xxxxxxxx" target="_blank")  Chrome extension
    |  to collect pages as you browse.

  p.text-center.text-xs.text-text-muted.mb-8
    | Opens in Claude, ChatGPT, Gemini, Perplexity, Grok, Copilot. Or copy the markdown.

  //- Why
  section.py-6.border-t.border-border-default
    h2.text-base.font-medium.mb-4 Why this exists

    ul.space-y-2.text-sm.text-text-secondary
      li No third party chat: use your own assistants
      li Combine multiple sources in one go
      li One click workflow
      li Shareable via link
      li Free, no account needed

  //- Use cases
  section.py-6.border-t.border-border-default
    h2.text-base.font-medium.mb-3 What you can do

    ul.text-sm.text-text-secondary.space-y-1
      li Learn or research a topic from multiple sources
      li Summarize and discuss one or several hours-long podcasts
      li Compare product reviews
      li Save a lot of time

  //- How it works
  section.py-6.border-t.border-border-default
    h2.text-base.font-medium.mb-3 How it works

    ol.text-sm.text-text-secondary.list-decimal.list-inside.space-y-1
      li Paste one or more URLs (or use the Chrome extension)
      li Content is extracted and compiled into a markdown page
      li Click "Open in Claude" (or any AI), it fetches the markdown directly

  //- FAQ
  section.py-6.border-t.border-border-default
    h2.text-base.font-medium.mb-3 FAQ

    .space-y-3.text-sm
      div
        p.text-text-primary Is it free?
        p.text-text-muted Yes. No account needed.

      div
        p.text-text-primary Is my data private?
        p.text-text-muted
          | Your AI conversations take place in your own assistant. Markdown pages which contain compiled online content can be one-click deleted by you at anytime.

  //- Script
  script.
    (function() {
      var LLM_URLS = {
        claude: function(p) { return 'https://claude.ai/new?q=' + encodeURIComponent(p); },
        chatgpt: function(p) { return 'https://chat.openai.com/?q=' + encodeURIComponent(p); },
        gemini: function(p) { return 'https://www.google.com/search?udm=50&aep=11&q=' + encodeURIComponent(p); },
        perplexity: function(p) { return 'https://www.perplexity.ai/search/?q=' + encodeURIComponent(p); },
        grok: function(p) { return 'https://x.com/i/grok?text=' + encodeURIComponent(p); },
        copilot: function(p) { return 'https://copilot.microsoft.com/?q=' + encodeURIComponent(p); }
      };

      var form = document.querySelector('form[action="/create"]');
      var submitBtn = document.getElementById('submit-btn');
      var menu = document.getElementById('send-to-menu');
      var wrapper = document.getElementById('send-to-wrapper');
      var hideTimeout = null;

      function syncMenuWidth() {
        menu.style.width = submitBtn.offsetWidth + 'px';
      }
      function showMenu() {
        syncMenuWidth();
        menu.classList.remove('hidden');
      }
      function hideMenu() {
        menu.classList.add('hidden');
      }
      window.addEventListener('resize', function() {
        if (!menu.classList.contains('hidden')) syncMenuWidth();
      });

      // Show/hide menu on hover
      wrapper.addEventListener('mouseenter', function() {
        clearTimeout(hideTimeout);
        showMenu();
      });
      wrapper.addEventListener('mouseleave', function() {
        hideTimeout = setTimeout(hideMenu, 200);
      });

      // Toggle on click
      submitBtn.addEventListener('click', function() {
        if (menu.classList.contains('hidden')) { showMenu(); } else { hideMenu(); }
      });

      // Close menu on outside click
      document.addEventListener('click', function(e) {
        if (!wrapper.contains(e.target)) {
          hideMenu();
        }
      });

      // Handle menu item clicks
      document.querySelectorAll('.send-to-item').forEach(function(item) {
        item.addEventListener('click', function() {
          var llm = this.dataset.llm;
          var action = this.dataset.action;
          hideMenu();

          // Validate textarea
          var textarea = form.querySelector('textarea');
          if (!textarea.value.trim()) {
            textarea.focus();
            return;
          }

          // Add to existing collection: different flow
          if (action === 'add-to-collection') {
            var collectionId = this.dataset.collectionId;
            var urls = textarea.value.trim().split('\n').filter(function(u) { return u.trim(); });
            var clickedBtn = this;
            clickedBtn.textContent = 'Adding...';
            submitBtn.disabled = true;

            var addNext = function(i) {
              if (i >= urls.length) {
                clickedBtn.textContent = 'Added!';
                submitBtn.disabled = false;
                setTimeout(function() { clickedBtn.textContent = clickedBtn.getAttribute('data-original-text'); }, 2000);
                return;
              }
              fetch('/s/' + collectionId + '/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
                body: 'url=' + encodeURIComponent(urls[i].trim())
              })
              .then(function(res) { return res.json(); })
              .then(function() { addNext(i + 1); })
              .catch(function() { addNext(i + 1); });
            };
            addNext(0);
            return;
          }

          submitBtn.disabled = true;
          submitBtn.textContent = 'Extracting...';

          fetch('/create', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'Accept': 'application/json'
            },
            body: new URLSearchParams(new FormData(form))
          })
          .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
          .then(function(result) {
            if (!result.ok) {
              alert(result.data.error || 'Something went wrong');
              return;
            }

            var d = result.data;
            var mdUrl = d.mdUrl;
            var prompt = 'Fetch ' + mdUrl;

            if (llm) {
              window.open(LLM_URLS[llm](prompt), '_blank');
            } else if (action === 'copy-link') {
              navigator.clipboard.writeText(mdUrl);
            } else if (action === 'copy-md') {
              fetch(mdUrl)
                .then(function(r) { return r.text(); })
                .then(function(md) { navigator.clipboard.writeText(md); });
            }

            submitBtn.textContent = 'Done';
            setTimeout(function() {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Extract, Combine & Send to...';
            }, 2000);
          })
          .catch(function(err) {
            alert('Error: ' + err.message);
          })
          .finally(function() {
            if (submitBtn.textContent === 'Extracting...') {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Extract, Combine & Send to...';
            }
          });
        });
      });
    })();
