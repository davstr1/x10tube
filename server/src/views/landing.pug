extends layout

block content
  //- Hero
  section.mb-6.text-center
    h1.text-xl.md_text-2xl.font-semibold.text-text-primary.mb-2
      | Send any page(s) to your AI.

    p.text-sm.text-text-secondary
      | YouTube videos, articles, web pages — combine them and send to your favorite assistant.

  //- Formulaire
  section.mb-4
    form(action="/create" method="POST")
      textarea.w-full.px-3.py-2.border.border-border-strong.rounded-md.text-base.focus_outline-none.focus_border-text-muted.resize-none.font-mono.text-sm.bg-surface.text-text-primary(
        name="urls"
        rows="4"
        placeholder="https://youtube.com/watch?v=...\nhttps://example.com/article"
        required
      )
      button#submit-btn.mt-3.w-full.bg-red-600.hover_bg-red-700.text-white.px-4.py-3.rounded-md.text-sm.font-medium(type="submit")
        | Extract, Combine &amp; Send to...

    if error
      .bg-red-900.border.border-red-700.rounded-md.p-3.mt-3.text-red-200.text-sm
        p= error
        if failedUrls && failedUrls.length > 0
          ul.mt-2.list-disc.list-inside
            each fail in failedUrls
              li #{fail.url}: #{fail.error}

  //- Extension + LLMs
  p.text-center.text-sm.text-text-muted.mb-2
    | Or use the
    a.text-red-600(href="https://chromewebstore.google.com/detail/toyourai/xxxxxxxx" target="_blank")  Chrome extension
    |  to collect pages as you browse.

  p.text-center.text-xs.text-text-muted.mb-8
    | Opens in Claude, ChatGPT, Gemini, Perplexity, Grok, Copilot — or copy the markdown.

  //- Why
  section.py-6.border-t.border-border-default
    h2.text-base.font-medium.mb-4 Why this exists

    ul.space-y-2.text-sm.text-text-secondary
      li No third party chat — you use your own assistants
      li Combine multiple sources in one go
      li One click workflow
      li Shareable via link
      li Free, no account needed

  //- Use cases
  section.py-6.border-t.border-border-default
    h2.text-base.font-medium.mb-3 What you can do

    ul.text-sm.text-text-secondary.space-y-1
      li Research a topic from multiple sources
      li Summarize a 2-hour podcast
      li Compare product reviews
      li Catch up on a conference

  //- How it works
  section.py-6.border-t.border-border-default
    h2.text-base.font-medium.mb-3 How it works

    ol.text-sm.text-text-secondary.list-decimal.list-inside.space-y-1
      li Paste one or more URLs
      li We extract the content into markdown
      li Click "Open in Claude" (or any AI) — it fetches the markdown directly

  //- FAQ
  section.py-6.border-t.border-border-default
    h2.text-base.font-medium.mb-3 FAQ

    .space-y-3.text-sm
      div
        p.text-text-primary Is it free?
        p.text-text-muted Yes. No account needed.

      div
        p.text-text-primary Is my data private?
        p.text-text-muted
          | Collections are accessible via their URL. We don't store your AI conversations.

  //- Script popup
  script.
    (function() {
      var LLM_URLS = {
        claude: function(p) { return 'https://claude.ai/new?q=' + encodeURIComponent(p); },
        chatgpt: function(p) { return 'https://chat.openai.com/?q=' + encodeURIComponent(p); },
        gemini: function(p) { return 'https://www.google.com/search?udm=50&aep=11&q=' + encodeURIComponent(p); },
        perplexity: function(p) { return 'https://www.perplexity.ai/search/?q=' + encodeURIComponent(p); },
        grok: function(p) { return 'https://x.com/i/grok?text=' + encodeURIComponent(p); },
        copilot: function(p) { return 'https://copilot.microsoft.com/?q=' + encodeURIComponent(p); }
      };
      var LLMS = ['claude', 'chatgpt', 'gemini', 'perplexity', 'grok', 'copilot'];
      var LLM_LABELS = { claude: 'Claude', chatgpt: 'ChatGPT', gemini: 'Gemini', perplexity: 'Perplexity', grok: 'Grok', copilot: 'Copilot' };

      var form = document.querySelector('form[action="/create"]');
      var submitBtn = document.getElementById('submit-btn');
      var currentMdUrl = '';
      var currentPrompt = '';
      var popup = null;

      function buildPopup() {
        var overlay = document.createElement('div');
        overlay.id = 'creation-popup';
        overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;display:flex;align-items:flex-start;justify-content:center;padding-top:6rem;';

        var backdrop = document.createElement('div');
        backdrop.id = 'popup-backdrop';
        backdrop.style.cssText = 'position:absolute;inset:0;';
        overlay.appendChild(backdrop);

        var card = document.createElement('div');
        card.style.cssText = 'position:relative;width:100%;max-width:24rem;margin:0 1rem;background:var(--color-surface);border:1px solid var(--color-border-strong);border-radius:0.5rem;box-shadow:0 10px 25px rgba(0,0,0,0.3);overflow:hidden;';
        overlay.appendChild(card);

        var header = document.createElement('div');
        header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;border-bottom:1px solid var(--color-border-default);';
        var headerLeft = document.createElement('div');
        var title = document.createElement('h3');
        title.id = 'popup-title';
        title.style.cssText = 'font-weight:600;color:var(--color-text-primary);';
        var meta = document.createElement('p');
        meta.id = 'popup-meta';
        meta.style.cssText = 'font-size:0.75rem;color:var(--color-text-muted);margin-top:0.25rem;';
        headerLeft.appendChild(title);
        headerLeft.appendChild(meta);
        var closeBtn = document.createElement('button');
        closeBtn.id = 'popup-close';
        closeBtn.type = 'button';
        closeBtn.innerHTML = '&times;';
        closeBtn.style.cssText = 'color:var(--color-text-muted);font-size:1.25rem;line-height:1;cursor:pointer;background:none;border:none;padding:0.25rem;';
        header.appendChild(headerLeft);
        header.appendChild(closeBtn);
        card.appendChild(header);

        var actions = document.createElement('div');
        actions.style.cssText = 'padding:0.5rem;';

        var openInWrap = document.createElement('div');
        openInWrap.style.cssText = 'position:relative;';
        var openInBtn = document.createElement('button');
        openInBtn.id = 'popup-open-in';
        openInBtn.type = 'button';
        openInBtn.innerHTML = '<span style="color:var(--color-text-muted)">&#9656;</span> Open in...';
        openInBtn.style.cssText = 'width:100%;display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;font-size:0.875rem;color:var(--color-text-primary);background:none;border:none;border-radius:0.375rem;cursor:pointer;text-align:left;';
        openInWrap.appendChild(openInBtn);

        var submenu = document.createElement('div');
        submenu.id = 'popup-llm-submenu';
        submenu.style.display = 'none';
        LLMS.forEach(function(llm) {
          var a = document.createElement('a');
          a.dataset.llm = llm;
          a.textContent = LLM_LABELS[llm];
          a.href = '#';
          a.target = '_blank';
          a.style.cssText = 'display:block;padding:0.5rem 0.75rem 0.5rem 2rem;font-size:0.875rem;color:var(--color-text-primary);text-decoration:none;border-radius:0.375rem;';
          submenu.appendChild(a);
        });
        openInWrap.appendChild(submenu);
        actions.appendChild(openInWrap);

        var copyLinkBtn = document.createElement('button');
        copyLinkBtn.id = 'popup-copy-link';
        copyLinkBtn.type = 'button';
        copyLinkBtn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDD17</span> Copy link';
        copyLinkBtn.style.cssText = 'width:100%;display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;font-size:0.875rem;color:var(--color-text-primary);background:none;border:none;border-radius:0.375rem;cursor:pointer;text-align:left;';
        actions.appendChild(copyLinkBtn);

        var copyContentBtn = document.createElement('button');
        copyContentBtn.id = 'popup-copy-content';
        copyContentBtn.type = 'button';
        copyContentBtn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDCCB</span> Copy markdown';
        copyContentBtn.style.cssText = 'width:100%;display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;font-size:0.875rem;color:var(--color-text-primary);background:none;border:none;border-radius:0.375rem;cursor:pointer;text-align:left;';
        actions.appendChild(copyContentBtn);
        card.appendChild(actions);

        var viewWrap = document.createElement('div');
        viewWrap.style.cssText = 'padding:0.75rem 1rem;border-top:1px solid var(--color-border-default);text-align:center;';
        var viewLink = document.createElement('a');
        viewLink.id = 'popup-view-link';
        viewLink.href = '#';
        viewLink.textContent = 'View collection \u2192';
        viewLink.style.cssText = 'font-size:0.875rem;color:var(--color-red-600, #dc2626);';
        viewWrap.appendChild(viewLink);
        card.appendChild(viewWrap);

        var failedWrap = document.createElement('div');
        failedWrap.id = 'popup-failed';
        failedWrap.style.display = 'none';
        var failedInner = document.createElement('div');
        failedInner.style.cssText = 'padding:0.75rem 1rem;border-top:1px solid var(--color-border-default);font-size:0.75rem;color:#f87171;';
        var failedLabel = document.createElement('p');
        failedLabel.style.fontWeight = '500';
        failedLabel.textContent = 'Some URLs failed:';
        var failedList = document.createElement('ul');
        failedList.id = 'popup-failed-list';
        failedList.style.cssText = 'list-style:disc inside;margin-top:0.25rem;';
        failedInner.appendChild(failedLabel);
        failedInner.appendChild(failedList);
        failedWrap.appendChild(failedInner);
        card.appendChild(failedWrap);

        var style = document.createElement('style');
        style.textContent = '#creation-popup button:hover, #popup-llm-submenu a:hover { background: var(--color-surface-hover); }';
        overlay.appendChild(style);

        document.body.appendChild(overlay);
        return overlay;
      }

      function showPopup() {
        if (!popup) popup = buildPopup();
        popup.style.display = 'flex';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Done';
        bindPopupEvents();
      }

      var eventsBound = false;
      function bindPopupEvents() {
        if (eventsBound) return;
        eventsBound = true;

        document.getElementById('popup-close').addEventListener('click', hidePopup);
        document.getElementById('popup-backdrop').addEventListener('click', hidePopup);

        document.getElementById('popup-open-in').addEventListener('click', function() {
          var sub = document.getElementById('popup-llm-submenu');
          sub.style.display = sub.style.display === 'none' ? 'block' : 'none';
        });

        document.getElementById('popup-copy-link').addEventListener('click', function() {
          var btn = this;
          navigator.clipboard.writeText(currentMdUrl);
          var original = btn.innerHTML;
          btn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDD17</span> Copied';
          setTimeout(function() { btn.innerHTML = original; }, 1500);
        });

        document.getElementById('popup-copy-content').addEventListener('click', function() {
          var btn = this;
          var original = btn.innerHTML;
          btn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDCCB</span> Fetching...';
          fetch(currentMdUrl)
            .then(function(r) { return r.text(); })
            .then(function(md) {
              navigator.clipboard.writeText(md);
              btn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDCCB</span> Copied';
              setTimeout(function() { btn.innerHTML = original; }, 1500);
            })
            .catch(function() {
              btn.innerHTML = '<span style="color:var(--color-text-muted)">\uD83D\uDCCB</span> Error';
              setTimeout(function() { btn.innerHTML = original; }, 1500);
            });
        });
      }

      function hidePopup() {
        if (popup) {
          popup.style.display = 'none';
          var sub = document.getElementById('popup-llm-submenu');
          if (sub) sub.style.display = 'none';
        }
        submitBtn.disabled = false;
        submitBtn.textContent = 'Extract, Combine & Send to...';
      }

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.textContent = 'Extracting...';
        hidePopup();

        fetch('/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
          },
          body: new URLSearchParams(new FormData(form))
        })
        .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
        .then(function(result) {
          if (!result.ok) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Extract, Combine & Send to...';
            alert(result.data.error || 'Something went wrong');
            return;
          }

          var d = result.data;
          currentMdUrl = d.mdUrl;
          currentPrompt = 'Fetch ' + d.mdUrl;

          showPopup();

          document.getElementById('popup-title').textContent = d.title;
          var tokens = d.tokenCount > 1000 ? Math.round(d.tokenCount / 1000) + 'K tokens' : d.tokenCount + ' tokens';
          document.getElementById('popup-meta').textContent = d.itemCount + ' item' + (d.itemCount > 1 ? 's' : '') + ' \u00b7 ~' + tokens;
          document.getElementById('popup-view-link').href = d.pageUrl;

          document.querySelectorAll('#popup-llm-submenu a').forEach(function(a) {
            a.href = LLM_URLS[a.dataset.llm](currentPrompt);
          });

          var failedEl = document.getElementById('popup-failed');
          if (d.failed && d.failed.length > 0) {
            var list = document.getElementById('popup-failed-list');
            list.innerHTML = '';
            d.failed.forEach(function(f) {
              var li = document.createElement('li');
              li.textContent = f.url + ': ' + f.error;
              list.appendChild(li);
            });
            failedEl.style.display = 'block';
          } else {
            failedEl.style.display = 'none';
          }
        })
        .catch(function(err) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Extract, Combine & Send to...';
          alert('Error: ' + err.message);
        });
      });
    })();
