# Audit : URLs et domaines hardcodés

## Problème

Plusieurs fichiers contiennent `http://localhost:3000` ou des noms de domaine en dur. Pour passer en production, il faut centraliser ça dans une configuration.

---

## Occurrences trouvées

### 1. Extension Chrome — `DEFAULT_BASE_URL`

3 fichiers avec la même constante :

| Fichier | Ligne | Code |
|---------|-------|------|
| `extension/api.js` | 4 | `const DEFAULT_BASE_URL = 'http://localhost:3000';` |
| `extension/content.js` | 4 | `const DEFAULT_BASE_URL = 'http://localhost:3000';` |
| `extension/background.js` | 4 | `const DEFAULT_BASE_URL = 'http://localhost:3000';` |

Ces 3 fichiers utilisent `chrome.storage.local.get(['styaBackendUrl'])` pour surcharger la valeur, mais le fallback est toujours `localhost:3000`.

### 2. Serveur — Fallback `BASE_URL`

Le serveur utilise déjà `process.env.BASE_URL` mais avec un fallback localhost :

| Fichier | Ligne | Code |
|---------|-------|------|
| `server/src/routes/x10.ts` | 54 | `` const baseUrl = process.env.BASE_URL \|\| 'http://localhost:3000'; `` |
| `server/src/views/x10.pug` | 27 | `` `${process.env.BASE_URL \|\| 'http://localhost:3000'}/s/${x10.id}.md` `` |
| `server/src/views/x10.pug` | 92 | `` `${process.env.BASE_URL \|\| 'http://localhost:3000'}/s/${x10.id}` `` |
| `server/src/views/x10.pug` | 141 | `` `${process.env.BASE_URL \|\| 'http://localhost:3000'}/s/${x10.id}/v/${itemId}.md` `` |
| `server/src/views/myx10s.pug` | 45 | `` `${process.env.BASE_URL \|\| 'http://localhost:3000'}/s/${x10.id}.md` `` |
| `server/src/views/myx10s.pug` | 46 | `` `${process.env.BASE_URL \|\| 'http://localhost:3000'}/s/${x10.id}` `` |

### 3. CORS — Domaines en dur

| Fichier | Ligne | Code |
|---------|-------|------|
| `server/src/routes/api.ts` | 16 | `origin.includes('localhost:3000')` |
| `server/src/routes/api.ts` | 17 | `origin.includes('x10tube.com')` |

### 4. Nom de marque — Titres de page

`server/src/routes/index.ts` contient 9 occurrences de `title: 'straighttoyour.ai'` ou `title: '... - straighttoyour.ai'`.

`server/src/routes/x10.ts` contient 2 occurrences de `Generated by straighttoyour.ai` (footer markdown).

---

## Plan de centralisation

### Côté serveur

Créer un fichier `server/src/config.ts` :

```typescript
export const config = {
  baseUrl: process.env.BASE_URL || 'http://localhost:3000',
  appName: process.env.APP_NAME || 'straighttoyour.ai',
  allowedOrigins: (process.env.ALLOWED_ORIGINS || 'localhost:3000,youtube.com').split(','),
  port: parseInt(process.env.PORT || '3000', 10),
};
```

Puis remplacer dans tous les fichiers serveur :
- `process.env.BASE_URL || 'http://localhost:3000'` → `config.baseUrl`
- `'straighttoyour.ai'` dans les titres → `config.appName`
- Les domaines CORS en dur → `config.allowedOrigins`

Passer `config.baseUrl` et `config.appName` aux templates Pug via `app.locals` pour éviter de le répéter dans chaque route.

### Côté extension

L'extension a déjà le mécanisme `chrome.storage.local.get(['styaBackendUrl'])`. Le `DEFAULT_BASE_URL` est un fallback pour le développement. Pour la production, deux options :

**Option A** : Changer le `DEFAULT_BASE_URL` au build (script de build qui remplace la valeur).

**Option B** : Garder le fallback localhost pour le dev, et utiliser la page `/sync` pour configurer l'URL de production dans `chrome.storage.local`. C'est le mécanisme actuel.

L'option B est déjà en place. Le seul changement nécessaire serait de mettre l'URL de production comme `DEFAULT_BASE_URL` quand on publie l'extension sur le Chrome Web Store.

---

## Priorité

| Changement | Priorité | Raison |
|-----------|----------|--------|
| `server/src/config.ts` centralisé | Haute | Élimine toutes les répétitions côté serveur |
| `app.locals` pour les templates Pug | Haute | Les views n'ont plus besoin de `process.env` |
| CORS configurable | Haute | Nécessaire pour la production |
| Extension `DEFAULT_BASE_URL` | Moyenne | Fonctionne déjà via chrome.storage, juste le fallback à changer au build |
| Nom de marque centralisé | Basse | Cosmétique, change rarement |
